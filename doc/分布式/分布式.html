<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.428571; overflow-x: hidden; background: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; font-size: inherit; line-height: inherit; font-family: inherit; font-size-adjust: inherit; font-kerning: inherit; font-variant-alternates: inherit; font-variant-ligatures: inherit; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-position: inherit; font-variant-emoji: inherit; font-feature-settings: inherit; font-optical-sizing: inherit; font-variation-settings: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right-width: 0px; border-right-style: none; border-right-color: currentcolor; background-color: inherit; }
.CodeMirror-linenumber { -webkit-user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: medium; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: medium !important; border-style: none !important; border-color: currentcolor !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom-width: 0px; border-bottom-style: none; border-bottom-color: currentcolor; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: medium; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.428571rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: "ï„¥"; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: "ï„£"; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left-width: 28px; border-left-style: solid; border-left-color: transparent; border-right-width: 28px; border-right-style: solid; border-right-color: transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: "ï„£"; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right-width: 8px; border-right-style: solid; border-right-color: transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "âˆ’"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }
.md-alert.md-alert-note { border-left-color: rgb(9, 105, 218); }
.md-alert.md-alert-important { border-left-color: rgb(130, 80, 223); }
.md-alert.md-alert-warning { border-left-color: rgb(154, 103, 0); }
.md-alert.md-alert-tip { border-left-color: rgb(31, 136, 61); }
.md-alert.md-alert-caution { border-left-color: rgb(207, 34, 46); }
.md-alert { padding: 0px 1em; margin-bottom: 16px; color: inherit; border-left-width: 0.25em; border-left-style: solid; border-left-color: rgb(0, 0, 0); }
.md-alert-text-note { color: rgb(9, 105, 218); }
.md-alert-text-important { color: rgb(130, 80, 223); }
.md-alert-text-warning { color: rgb(154, 103, 0); }
.md-alert-text-tip { color: rgb(31, 136, 61); }
.md-alert-text-caution { color: rgb(207, 34, 46); }
.md-alert-text { font-size: 0.9rem; font-weight: 700; }
.md-alert-text svg { fill: currentcolor; position: relative; top: 0.125em; margin-right: 1ch; overflow: visible; }
.md-alert-text-container::after { content: attr(data-text); text-transform: capitalize; pointer-events: none; margin-right: 1ch; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: medium !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-width: medium; border-right-style: none; border-right-color: currentcolor; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-width: medium; border-right-style: none; border-right-color: currentcolor; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    pre {
        page-break-inside: avoid;
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.mac-os #write{
    caret-color: AccentColor;
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}


 @media print { @page {margin: 0 0 0 0;} body.typora-export {padding-left: 0; padding-right: 0;} #write {padding:0;}}
</style><title>åˆ†å¸ƒå¼</title>
</head>
<body class='typora-export typora-export-show-outline typora-export-no-collapse-outline'><div class='typora-export-content'>
<div class="typora-export-sidebar"><div class="outline-content"><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#ä¸€åˆ†å¸ƒå¼ç†è®º">ä¸€ã€åˆ†å¸ƒå¼ç†è®º</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#cap-ç†è®º">CAP ç†è®º</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#ä¸æ˜¯æ‰€è°“çš„3-é€‰-2">ä¸æ˜¯æ‰€è°“çš„â€œ3 é€‰ 2â€</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#cap-å®é™…åº”ç”¨æ¡ˆä¾‹">CAP å®é™…åº”ç”¨æ¡ˆä¾‹</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#base-ç†è®º">BASE ç†è®º</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#åŸºæœ¬å¯ç”¨">åŸºæœ¬å¯ç”¨</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#è½¯çŠ¶æ€">è½¯çŠ¶æ€</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#æœ€ç»ˆä¸€è‡´æ€§">æœ€ç»ˆä¸€è‡´æ€§</a></div><ul class="outline-children"></ul></li></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#paxos-ç®—æ³•è¯¦è§£">Paxos ç®—æ³•è¯¦è§£</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#äºŒåˆ†å¸ƒå¼é”">äºŒã€åˆ†å¸ƒå¼é”</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”">ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å“ªäº›æ¡ä»¶">åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å“ªäº›æ¡ä»¶ï¼Ÿ</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#åˆ†å¸ƒå¼é”çš„å¸¸è§å®ç°æ–¹å¼æœ‰å“ªäº›">åˆ†å¸ƒå¼é”çš„å¸¸è§å®ç°æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#åŸºäº-redis-å®ç°åˆ†å¸ƒå¼é”">åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#åŸºäº-zookeeper-å®ç°åˆ†å¸ƒå¼é”">åŸºäº ZooKeeper å®ç°åˆ†å¸ƒå¼é”</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#åˆ†å¸ƒå¼é”çš„é€‰æ‹©">åˆ†å¸ƒå¼é”çš„é€‰æ‹©</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#ä¸‰åˆ†å¸ƒå¼id">ä¸‰ã€åˆ†å¸ƒå¼ID </a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#ä»€ä¹ˆæ˜¯-id">ä»€ä¹ˆæ˜¯ IDï¼Ÿ</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼-id">ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ IDï¼Ÿ</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#åˆ†å¸ƒå¼-id-éœ€è¦æ»¡è¶³å“ªäº›è¦æ±‚">åˆ†å¸ƒå¼ ID éœ€è¦æ»¡è¶³å“ªäº›è¦æ±‚?</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#åˆ†å¸ƒå¼-id-å¸¸è§è§£å†³æ–¹æ¡ˆ">åˆ†å¸ƒå¼ ID å¸¸è§è§£å†³æ–¹æ¡ˆ</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#æ•°æ®åº“">æ•°æ®åº“</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#æ•°æ®åº“å·æ®µæ¨¡å¼">æ•°æ®åº“å·æ®µæ¨¡å¼</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#nosql">NoSQL</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#ç®—æ³•">ç®—æ³•</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#å¼€æºæ¡†æ¶">å¼€æºæ¡†æ¶</a></div><ul class="outline-children"></ul></li></ul></li></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#å››æœåŠ¡å‘ç°æ³¨å†Œ">å››ã€æœåŠ¡å‘ç°/æ³¨å†Œ</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1-zookeeper">1. Zookeeper</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#æ¦‚è¿°">æ¦‚è¿°</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#ä¸€è‡´æ€§åè®®å’Œç®—æ³•">ä¸€è‡´æ€§åè®®å’Œç®—æ³•</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#zookeeper-æ¶æ„">Zookeeper æ¶æ„</a></div><ul class="outline-children"></ul></li></ul></li></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#äº”rpc">äº”ã€RPC</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1-ä¸€ä¸ªrpcè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹">1. ä¸€ä¸ªRPCè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#11-æ¦‚è¿°">1.1. æ¦‚è¿°</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#12-clientç«¯">1.2. Clientç«¯</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#121-å®¢æˆ·ç«¯ä»£ç†">1.2.1. å®¢æˆ·ç«¯ä»£ç†</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#122-å®¢æˆ·ç«¯filter">1.2.2. å®¢æˆ·ç«¯Filter</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#123-è¿æ¥æ± ">1.2.3. è¿æ¥æ± </a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#124-çº¿ç¨‹æ± ">1.2.4. çº¿ç¨‹æ± </a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#125-netty-client">1.2.5. Netty Client</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h5"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1251-boss">1.2.5.1. Boss</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h5"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1252-worker">1.2.5.2. Worker</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h5"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1253-pipeline">1.2.5.3. Pipeline</a></div><ul class="outline-children"></ul></li></ul></li></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#13-serverç«¯">1.3. Serverç«¯</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#131-æœåŠ¡ç«¯filter">1.3.1. æœåŠ¡ç«¯Filter</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#132-çº¿ç¨‹æ± ">1.3.2. çº¿ç¨‹æ± </a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#133-netty-server">1.3.3. Netty Server</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#14-æ‰§è¡Œè¿‡ç¨‹">1.4. æ‰§è¡Œè¿‡ç¨‹</a></div><ul class="outline-children"></ul></li></ul></li></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#å…­é“¾è·¯è¿½è¸ª">å…­ã€é“¾è·¯è¿½è¸ª</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#ä¸ƒåˆ†å¸ƒå¼äº‹åŠ¡">ä¸ƒã€åˆ†å¸ƒå¼äº‹åŠ¡</a></div><ul class="outline-children"></ul></li></div></div><div id='write'  class=''><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n3"><a class="md-toc-inner" href="#ä¸€åˆ†å¸ƒå¼ç†è®º">ä¸€ã€åˆ†å¸ƒå¼ç†è®º</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4"><a class="md-toc-inner" href="#cap-ç†è®º">CAP ç†è®º</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n18"><a class="md-toc-inner" href="#ä¸æ˜¯æ‰€è°“çš„3-é€‰-2">ä¸æ˜¯æ‰€è°“çš„â€œ3 é€‰ 2â€</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n27"><a class="md-toc-inner" href="#cap-å®é™…åº”ç”¨æ¡ˆä¾‹">CAP å®é™…åº”ç”¨æ¡ˆä¾‹</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n30"><a class="md-toc-inner" href="#base-ç†è®º">BASE ç†è®º</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n32"><a class="md-toc-inner" href="#æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n35"><a class="md-toc-inner" href="#åŸºæœ¬å¯ç”¨">åŸºæœ¬å¯ç”¨</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n43"><a class="md-toc-inner" href="#è½¯çŠ¶æ€">è½¯çŠ¶æ€</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n45"><a class="md-toc-inner" href="#æœ€ç»ˆä¸€è‡´æ€§">æœ€ç»ˆä¸€è‡´æ€§</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n55"><a class="md-toc-inner" href="#paxos-ç®—æ³•è¯¦è§£">Paxos ç®—æ³•è¯¦è§£</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n59"><a class="md-toc-inner" href="#äºŒåˆ†å¸ƒå¼é”">äºŒã€åˆ†å¸ƒå¼é”</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n60"><a class="md-toc-inner" href="#ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”">ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n67"><a class="md-toc-inner" href="#åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å“ªäº›æ¡ä»¶">åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å“ªäº›æ¡ä»¶ï¼Ÿ</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n82"><a class="md-toc-inner" href="#åˆ†å¸ƒå¼é”çš„å¸¸è§å®ç°æ–¹å¼æœ‰å“ªäº›">åˆ†å¸ƒå¼é”çš„å¸¸è§å®ç°æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n92"><a class="md-toc-inner" href="#åŸºäº-redis-å®ç°åˆ†å¸ƒå¼é”">åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n131"><a class="md-toc-inner" href="#åŸºäº-zookeeper-å®ç°åˆ†å¸ƒå¼é”">åŸºäº ZooKeeper å®ç°åˆ†å¸ƒå¼é”</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n196"><a class="md-toc-inner" href="#åˆ†å¸ƒå¼é”çš„é€‰æ‹©">åˆ†å¸ƒå¼é”çš„é€‰æ‹©</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n199"><a class="md-toc-inner" href="#ä¸‰åˆ†å¸ƒå¼id">ä¸‰ã€åˆ†å¸ƒå¼ID </a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n200"><a class="md-toc-inner" href="#ä»€ä¹ˆæ˜¯-id">ä»€ä¹ˆæ˜¯ IDï¼Ÿ</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n204"><a class="md-toc-inner" href="#ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼-id">ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ IDï¼Ÿ</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n210"><a class="md-toc-inner" href="#åˆ†å¸ƒå¼-id-éœ€è¦æ»¡è¶³å“ªäº›è¦æ±‚">åˆ†å¸ƒå¼ ID éœ€è¦æ»¡è¶³å“ªäº›è¦æ±‚?</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n232"><a class="md-toc-inner" href="#åˆ†å¸ƒå¼-id-å¸¸è§è§£å†³æ–¹æ¡ˆ">åˆ†å¸ƒå¼ ID å¸¸è§è§£å†³æ–¹æ¡ˆ</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n233"><a class="md-toc-inner" href="#æ•°æ®åº“">æ•°æ®åº“</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n255"><a class="md-toc-inner" href="#æ•°æ®åº“å·æ®µæ¨¡å¼">æ•°æ®åº“å·æ®µæ¨¡å¼</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n280"><a class="md-toc-inner" href="#nosql">NoSQL</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n290"><a class="md-toc-inner" href="#ç®—æ³•">ç®—æ³•</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n348"><a class="md-toc-inner" href="#å¼€æºæ¡†æ¶">å¼€æºæ¡†æ¶</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n356"><a class="md-toc-inner" href="#å››æœåŠ¡å‘ç°æ³¨å†Œ">å››ã€æœåŠ¡å‘ç°/æ³¨å†Œ</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n357"><a class="md-toc-inner" href="#1-zookeeper">1. Zookeeper</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n359"><a class="md-toc-inner" href="#æ¦‚è¿°">æ¦‚è¿°</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n367"><a class="md-toc-inner" href="#ä¸€è‡´æ€§åè®®å’Œç®—æ³•">ä¸€è‡´æ€§åè®®å’Œç®—æ³•</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n422"><a class="md-toc-inner" href="#zookeeper-æ¶æ„">Zookeeper æ¶æ„</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n425"><a class="md-toc-inner" href="#äº”rpc">äº”ã€RPC</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n426"><a class="md-toc-inner" href="#1-ä¸€ä¸ªrpcè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹">1. ä¸€ä¸ªRPCè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n427"><a class="md-toc-inner" href="#11-æ¦‚è¿°">1.1. æ¦‚è¿°</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n430"><a class="md-toc-inner" href="#12-clientç«¯">1.2. Clientç«¯</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n432"><a class="md-toc-inner" href="#121-å®¢æˆ·ç«¯ä»£ç†">1.2.1. å®¢æˆ·ç«¯ä»£ç†</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n434"><a class="md-toc-inner" href="#122-å®¢æˆ·ç«¯filter">1.2.2. å®¢æˆ·ç«¯Filter</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n436"><a class="md-toc-inner" href="#123-è¿æ¥æ± ">1.2.3. è¿æ¥æ± </a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n438"><a class="md-toc-inner" href="#124-çº¿ç¨‹æ± ">1.2.4. çº¿ç¨‹æ± </a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n440"><a class="md-toc-inner" href="#125-netty-client">1.2.5. Netty Client</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n442"><a class="md-toc-inner" href="#1251-boss">1.2.5.1. Boss</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n444"><a class="md-toc-inner" href="#1252-worker">1.2.5.2. Worker</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n446"><a class="md-toc-inner" href="#1253-pipeline">1.2.5.3. Pipeline</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n448"><a class="md-toc-inner" href="#13-serverç«¯">1.3. Serverç«¯</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n450"><a class="md-toc-inner" href="#131-æœåŠ¡ç«¯filter">1.3.1. æœåŠ¡ç«¯Filter</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n452"><a class="md-toc-inner" href="#132-çº¿ç¨‹æ± ">1.3.2. çº¿ç¨‹æ± </a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n454"><a class="md-toc-inner" href="#133-netty-server">1.3.3. Netty Server</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n456"><a class="md-toc-inner" href="#14-æ‰§è¡Œè¿‡ç¨‹">1.4. æ‰§è¡Œè¿‡ç¨‹</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n490"><a class="md-toc-inner" href="#å…­é“¾è·¯è¿½è¸ª">å…­ã€é“¾è·¯è¿½è¸ª</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n491"><a class="md-toc-inner" href="#ä¸ƒåˆ†å¸ƒå¼äº‹åŠ¡">ä¸ƒã€åˆ†å¸ƒå¼äº‹åŠ¡</a></span></p></div><p>&nbsp;</p><h1 id='ä¸€åˆ†å¸ƒå¼ç†è®º'><span>ä¸€ã€åˆ†å¸ƒå¼ç†è®º</span></h1><h2 id='cap-ç†è®º'><span>CAP ç†è®º</span></h2><p><strong><span>CAP</span></strong><span> ä¹Ÿå°±æ˜¯ </span><strong><span>Consistencyï¼ˆä¸€è‡´æ€§ï¼‰</span></strong><span>ã€</span><strong><span>Availabilityï¼ˆå¯ç”¨æ€§ï¼‰</span></strong><span>ã€</span><strong><span>Partition Toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰</span></strong><span> è¿™ä¸‰ä¸ªå•è¯é¦–å­—æ¯ç»„åˆã€‚</span></p><p><span>CAP ç†è®ºçš„æå‡ºè€…å¸ƒé²å°”åœ¨æå‡º CAP çŒœæƒ³çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰è¯¦ç»†å®šä¹‰ </span><strong><span>Consistency</span></strong><span>ã€</span><strong><span>Availability</span></strong><span>ã€</span><strong><span>Partition Tolerance</span></strong><span> ä¸‰ä¸ªå•è¯çš„æ˜ç¡®å®šä¹‰ã€‚</span></p><p><span>å› æ­¤ï¼Œå¯¹äº CAP çš„æ°‘é—´è§£è¯»æœ‰å¾ˆå¤šï¼Œä¸€èˆ¬æ¯”è¾ƒè¢«å¤§å®¶æ¨èçš„æ˜¯ä¸‹é¢ ğŸ‘‡ è¿™ç§ç‰ˆæœ¬çš„è§£è¯»ã€‚</span></p><p><span>åœ¨ç†è®ºè®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒCAP å®šç†ï¼ˆCAP theoremï¼‰æŒ‡å‡ºå¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œå½“è®¾è®¡è¯»å†™æ“ä½œæ—¶ï¼Œåªèƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ç‚¹ä¸­çš„ä¸¤ä¸ªï¼š</span></p><ul><li><p><strong><span>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰</span></strong><span> : æ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®å‰¯æœ¬</span></p></li><li><p><strong><span>å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰</span></strong><span>: éæ•…éšœçš„èŠ‚ç‚¹åœ¨åˆç†çš„æ—¶é—´å†…è¿”å›åˆç†çš„å“åº”ï¼ˆä¸æ˜¯é”™è¯¯æˆ–è€…è¶…æ—¶çš„å“åº”ï¼‰ã€‚</span></p></li><li><p><strong><span>åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition Toleranceï¼‰</span></strong><span> : åˆ†å¸ƒå¼ç³»ç»Ÿå‡ºç°ç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œä»ç„¶èƒ½å¤Ÿå¯¹å¤–æä¾›æœåŠ¡ã€‚</span></p></li></ul><p><strong><span>ä»€ä¹ˆæ˜¯ç½‘ç»œåˆ†åŒºï¼Ÿ</span></strong></p><p><span>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œæœ¬æ¥æ˜¯è¿é€šçš„ï¼Œä½†æ˜¯å› ä¸ºæŸäº›æ•…éšœï¼ˆæ¯”å¦‚éƒ¨åˆ†èŠ‚ç‚¹ç½‘ç»œå‡ºäº†é—®é¢˜ï¼‰æŸäº›èŠ‚ç‚¹ä¹‹é—´ä¸è¿é€šäº†ï¼Œæ•´ä¸ªç½‘ç»œå°±åˆ†æˆäº†å‡ å—åŒºåŸŸï¼Œè¿™å°±å« </span><strong><span>ç½‘ç»œåˆ†åŒº</span></strong><span>ã€‚</span></p><h3 id='ä¸æ˜¯æ‰€è°“çš„3-é€‰-2'><span>ä¸æ˜¯æ‰€è°“çš„â€œ3 é€‰ 2â€</span></h3><p><span>å¤§éƒ¨åˆ†äººè§£é‡Šè¿™ä¸€å®šå¾‹æ—¶ï¼Œå¸¸å¸¸ç®€å•çš„è¡¨è¿°ä¸ºï¼šâ€œä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹å¿æ€§ä¸‰è€…ä½ åªèƒ½åŒæ—¶è¾¾åˆ°å…¶ä¸­ä¸¤ä¸ªï¼Œä¸å¯èƒ½åŒæ—¶è¾¾åˆ°â€ã€‚å®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªéå¸¸å…·æœ‰è¯¯å¯¼æ€§è´¨çš„è¯´æ³•ï¼Œè€Œä¸”åœ¨ CAP ç†è®ºè¯ç”Ÿ 12 å¹´ä¹‹åï¼ŒCAP ä¹‹çˆ¶ä¹Ÿåœ¨ 2012 å¹´é‡å†™äº†ä¹‹å‰çš„è®ºæ–‡ã€‚</span></p><blockquote><p><strong><span>å½“å‘ç”Ÿç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬è¦ç»§ç»­æœåŠ¡ï¼Œé‚£ä¹ˆå¼ºä¸€è‡´æ€§å’Œå¯ç”¨æ€§åªèƒ½ 2 é€‰ 1ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ç½‘ç»œåˆ†åŒºä¹‹å P æ˜¯å‰æï¼Œå†³å®šäº† P ä¹‹åæ‰æœ‰ C å’Œ A çš„é€‰æ‹©ã€‚ä¹Ÿå°±æ˜¯è¯´åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰æˆ‘ä»¬æ˜¯å¿…é¡»è¦å®ç°çš„ã€‚</span></strong></p><p><span>ç®€è€Œè¨€ä¹‹å°±æ˜¯ï¼šCAP ç†è®ºä¸­åˆ†åŒºå®¹é”™æ€§ P æ˜¯ä¸€å®šè¦æ»¡è¶³çš„ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œåªèƒ½æ»¡è¶³å¯ç”¨æ€§ A æˆ–è€…ä¸€è‡´æ€§ Cã€‚</span></p></blockquote><p><span>å› æ­¤ï¼Œ</span><strong><span>åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºä¸Šä¸å¯èƒ½é€‰æ‹© CA æ¶æ„ï¼Œåªèƒ½é€‰æ‹© CP æˆ–è€… AP æ¶æ„ã€‚</span></strong><span> æ¯”å¦‚ ZooKeeperã€HBase å°±æ˜¯ CP æ¶æ„ï¼ŒCassandraã€Eureka å°±æ˜¯ AP æ¶æ„ï¼ŒNacos ä¸ä»…æ”¯æŒ CP æ¶æ„ä¹Ÿæ”¯æŒ AP æ¶æ„ã€‚</span></p><p><strong><span>ä¸ºå•¥ä¸å¯èƒ½é€‰æ‹© CA æ¶æ„å‘¢ï¼Ÿ</span></strong><span> ä¸¾ä¸ªä¾‹å­ï¼šè‹¥ç³»ç»Ÿå‡ºç°â€œåˆ†åŒºâ€ï¼Œç³»ç»Ÿä¸­çš„æŸä¸ªèŠ‚ç‚¹åœ¨è¿›è¡Œå†™æ“ä½œã€‚ä¸ºäº†ä¿è¯ Cï¼Œ å¿…é¡»è¦ç¦æ­¢å…¶ä»–èŠ‚ç‚¹çš„è¯»å†™æ“ä½œï¼Œè¿™å°±å’Œ A å‘ç”Ÿå†²çªäº†ã€‚å¦‚æœä¸ºäº†ä¿è¯ Aï¼Œå…¶ä»–èŠ‚ç‚¹çš„è¯»å†™æ“ä½œæ­£å¸¸çš„è¯ï¼Œé‚£å°±å’Œ C å‘ç”Ÿå†²çªäº†ã€‚</span></p><p><strong><span>é€‰æ‹© CP è¿˜æ˜¯ AP çš„å…³é”®åœ¨äºå½“å‰çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ²¡æœ‰å®šè®ºï¼Œæ¯”å¦‚å¯¹äºéœ€è¦ç¡®ä¿å¼ºä¸€è‡´æ€§çš„åœºæ™¯å¦‚é“¶è¡Œä¸€èˆ¬ä¼šé€‰æ‹©ä¿è¯ CP ã€‚</span></strong></p><p><span>å¦å¤–ï¼Œéœ€è¦è¡¥å……è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼š</span><strong><span>å¦‚æœç½‘ç»œåˆ†åŒºæ­£å¸¸çš„è¯ï¼ˆç³»ç»Ÿåœ¨ç»å¤§éƒ¨åˆ†æ—¶å€™æ‰€å¤„çš„çŠ¶æ€ï¼‰ï¼Œä¹Ÿå°±è¯´ä¸éœ€è¦ä¿è¯ P çš„æ—¶å€™ï¼ŒC å’Œ A èƒ½å¤ŸåŒæ—¶ä¿è¯ã€‚</span></strong></p><h3 id='cap-å®é™…åº”ç”¨æ¡ˆä¾‹'><span>CAP å®é™…åº”ç”¨æ¡ˆä¾‹</span></h3><p><strong><span>ZooKeeper ä¿è¯çš„æ˜¯ CPã€‚</span></strong><span> ä»»ä½•æ—¶åˆ»å¯¹ ZooKeeper çš„è¯»è¯·æ±‚éƒ½èƒ½å¾—åˆ°ä¸€è‡´æ€§çš„ç»“æœï¼Œä½†æ˜¯ï¼Œ ZooKeeper ä¸ä¿è¯æ¯æ¬¡è¯·æ±‚çš„å¯ç”¨æ€§æ¯”å¦‚åœ¨ Leader é€‰ä¸¾è¿‡ç¨‹ä¸­æˆ–è€…åŠæ•°ä»¥ä¸Šçš„æœºå™¨ä¸å¯ç”¨çš„æ—¶å€™æœåŠ¡å°±æ˜¯ä¸å¯ç”¨çš„ã€‚</span></p><p><strong><span>Eureka ä¿è¯çš„åˆ™æ˜¯ APã€‚</span></strong><span> Eureka åœ¨è®¾è®¡çš„æ—¶å€™å°±æ˜¯ä¼˜å…ˆä¿è¯ A ï¼ˆå¯ç”¨æ€§ï¼‰ã€‚åœ¨ Eureka ä¸­ä¸å­˜åœ¨ä»€ä¹ˆ Leader èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€æ ·çš„ã€å¹³ç­‰çš„ã€‚å› æ­¤ Eureka ä¸ä¼šåƒ ZooKeeper é‚£æ ·å‡ºç°é€‰ä¸¾è¿‡ç¨‹ä¸­æˆ–è€…åŠæ•°ä»¥ä¸Šçš„æœºå™¨ä¸å¯ç”¨çš„æ—¶å€™æœåŠ¡å°±æ˜¯ä¸å¯ç”¨çš„æƒ…å†µã€‚ Eureka ä¿è¯å³ä½¿å¤§éƒ¨åˆ†èŠ‚ç‚¹æŒ‚æ‰ä¹Ÿä¸ä¼šå½±å“æ­£å¸¸æä¾›æœåŠ¡ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¯ç”¨çš„å°±è¡Œäº†ã€‚åªä¸è¿‡è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„æ•°æ®å¯èƒ½å¹¶ä¸æ˜¯æœ€æ–°çš„ã€‚</span></p><h2 id='base-ç†è®º'><span>BASE ç†è®º</span></h2><p><strong><span>BASE</span></strong><span> æ˜¯ </span><strong><span>Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰</span></strong><span>ã€</span><strong><span>Soft-stateï¼ˆè½¯çŠ¶æ€ï¼‰</span></strong><span> å’Œ </span><strong><span>Eventually Consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰</span></strong><span> ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚BASE ç†è®ºæ˜¯å¯¹ CAP ä¸­ä¸€è‡´æ€§ C å’Œå¯ç”¨æ€§ A æƒè¡¡çš„ç»“æœï¼Œå…¶æ¥æºäºå¯¹å¤§è§„æ¨¡äº’è”ç½‘ç³»ç»Ÿåˆ†å¸ƒå¼å®è·µçš„æ€»ç»“ï¼Œæ˜¯åŸºäº CAP å®šç†é€æ­¥æ¼”åŒ–è€Œæ¥çš„ï¼Œå®ƒå¤§å¤§é™ä½äº†æˆ‘ä»¬å¯¹ç³»ç»Ÿçš„è¦æ±‚ã€‚</span></p><h3 id='æ ¸å¿ƒæ€æƒ³'><span>æ ¸å¿ƒæ€æƒ³</span></h3><p><strong><span>BASE ç†è®ºæœ¬è´¨ä¸Šæ˜¯å¯¹ CAP çš„å»¶ä¼¸å’Œè¡¥å……ï¼Œæ›´å…·ä½“åœ°è¯´ï¼Œæ˜¯å¯¹ CAP ä¸­ AP æ–¹æ¡ˆçš„ä¸€ä¸ªè¡¥å……ã€‚</span></strong></p><p><span>å› æ­¤ï¼ŒAP æ–¹æ¡ˆåªæ˜¯åœ¨ç³»ç»Ÿå‘ç”Ÿåˆ†åŒºçš„æ—¶å€™æ”¾å¼ƒä¸€è‡´æ€§ï¼Œè€Œä¸æ˜¯æ°¸è¿œæ”¾å¼ƒä¸€è‡´æ€§ã€‚åœ¨åˆ†åŒºæ•…éšœæ¢å¤åï¼Œç³»ç»Ÿåº”è¯¥è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚è¿™ä¸€ç‚¹å…¶å®å°±æ˜¯ BASE ç†è®ºå»¶ä¼¸çš„åœ°æ–¹ã€‚</span></p><h4 id='åŸºæœ¬å¯ç”¨'><span>åŸºæœ¬å¯ç”¨</span></h4><p><span>åŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚ä½†æ˜¯ï¼Œè¿™ç»ä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ã€‚</span></p><p><strong><span>ä»€ä¹ˆå«å…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§å‘¢ï¼Ÿ</span></strong></p><ul><li><p><strong><span>å“åº”æ—¶é—´ä¸Šçš„æŸå¤±</span></strong><span>: æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚éœ€è¦ 0.5s è¿”å›ç»“æœï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿå‡ºç°æ•…éšœï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚çš„æ—¶é—´å˜ä¸º 3 sã€‚</span></p></li><li><p><strong><span>ç³»ç»ŸåŠŸèƒ½ä¸Šçš„æŸå¤±</span></strong><span>ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ç³»ç»Ÿçš„å…¨éƒ¨åŠŸèƒ½ï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿè®¿é—®é‡çªç„¶å‰§å¢ï¼Œç³»ç»Ÿçš„éƒ¨åˆ†éæ ¸å¿ƒåŠŸèƒ½æ— æ³•ä½¿ç”¨ã€‚</span></p></li></ul><h4 id='è½¯çŠ¶æ€'><span>è½¯çŠ¶æ€</span></h4><p><span>è½¯çŠ¶æ€æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼ˆ</span><strong><span>CAP ç†è®ºä¸­çš„æ•°æ®ä¸ä¸€è‡´</span></strong><span>ï¼‰ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶ã€‚</span></p><h4 id='æœ€ç»ˆä¸€è‡´æ€§'><span>æœ€ç»ˆä¸€è‡´æ€§</span></h4><p><span>æœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œæœ€ç»ˆä¸€è‡´æ€§çš„æœ¬è´¨æ˜¯éœ€è¦ç³»ç»Ÿä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚</span></p><p><span>é‚£å®ç°æœ€ç»ˆä¸€è‡´æ€§çš„å…·ä½“æ–¹å¼æ˜¯ä»€ä¹ˆå‘¢?</span></p><ul><li><p><strong><span>è¯»æ—¶ä¿®å¤</span></strong><span> : åœ¨è¯»å–æ•°æ®æ—¶ï¼Œæ£€æµ‹æ•°æ®çš„ä¸ä¸€è‡´ï¼Œè¿›è¡Œä¿®å¤ã€‚æ¯”å¦‚ Cassandra çš„ Read Repair å®ç°ï¼Œå…·ä½“æ¥è¯´ï¼Œåœ¨å‘ Cassandra ç³»ç»ŸæŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœæ£€æµ‹åˆ°ä¸åŒèŠ‚ç‚¹çš„å‰¯æœ¬æ•°æ®ä¸ä¸€è‡´ï¼Œç³»ç»Ÿå°±è‡ªåŠ¨ä¿®å¤æ•°æ®ã€‚</span></p></li><li><p><strong><span>å†™æ—¶ä¿®å¤</span></strong><span> : åœ¨å†™å…¥æ•°æ®ï¼Œæ£€æµ‹æ•°æ®çš„ä¸ä¸€è‡´æ—¶ï¼Œè¿›è¡Œä¿®å¤ã€‚æ¯”å¦‚ Cassandra çš„ Hinted Handoff å®ç°ã€‚å…·ä½“æ¥è¯´ï¼ŒCassandra é›†ç¾¤çš„èŠ‚ç‚¹ä¹‹é—´è¿œç¨‹å†™æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœå†™å¤±è´¥ å°±å°†æ•°æ®ç¼“å­˜ä¸‹æ¥ï¼Œç„¶åå®šæ—¶é‡ä¼ ï¼Œä¿®å¤æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚</span></p></li><li><p><strong><span>å¼‚æ­¥ä¿®å¤</span></strong><span> : è¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œé€šè¿‡å®šæ—¶å¯¹è´¦æ£€æµ‹å‰¯æœ¬æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¹¶ä¿®å¤ã€‚</span></p></li></ul><h2 id='paxos-ç®—æ³•è¯¦è§£'><span>Paxos ç®—æ³•è¯¦è§£</span></h2><p><code>Paxos</code><span> ç®—æ³•æ˜¯åŸºäº</span><strong><span>æ¶ˆæ¯ä¼ é€’ä¸”å…·æœ‰é«˜åº¦å®¹é”™ç‰¹æ€§çš„ä¸€è‡´æ€§ç®—æ³•</span></strong><span>ï¼Œæ˜¯ç›®å‰å…¬è®¤çš„è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜æœ€æœ‰æ•ˆçš„ç®—æ³•ä¹‹ä¸€ï¼Œ</span><strong><span>å…¶è§£å†³çš„é—®é¢˜å°±æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¦‚ä½•å°±æŸä¸ªå€¼ï¼ˆå†³è®®ï¼‰è¾¾æˆä¸€è‡´</span></strong><span> ã€‚</span></p><p><span>åœ¨ </span><code>Paxos</code><span> ä¸­ä¸»è¦æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«ä¸º </span><code>Proposerææ¡ˆè€…</code><span>ã€</span><code>Acceptorè¡¨å†³è€…</code><span>ã€</span><code>Learnerå­¦ä¹ è€…</code><span>ã€‚</span><code>Paxos</code><span> ç®—æ³•å’Œ </span><code>2PC</code><span> ä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸º </span><code>Prepare</code><span> å’Œ </span><code>accept</code><span> é˜¶æ®µã€‚</span></p><p>&nbsp;</p><h1 id='äºŒåˆ†å¸ƒå¼é”'><span>äºŒã€åˆ†å¸ƒå¼é”</span></h1><h2 id='ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”'><span>ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ</span></h2><p><span>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼ˆä¾‹å¦‚å•†å“åº“å­˜ã€å¤–å–è®¢å•ï¼‰ï¼Œä¼šå‘ç”Ÿæ•°æ®ç«äº‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´å‡ºç°è„æ•°æ®æˆ–è€…ç³»ç»Ÿé—®é¢˜ï¼Œå¨èƒåˆ°ç¨‹åºçš„æ­£å¸¸è¿è¡Œã€‚</span></p><p><span>ä¸ºäº†ä¿è¯å…±äº«èµ„æºè¢«å®‰å…¨åœ°è®¿é—®ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨äº’æ–¥æ“ä½œå¯¹å…±äº«èµ„æºè¿›è¡Œä¿æŠ¤ï¼Œå³åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…å½“å‰çº¿ç¨‹é‡Šæ”¾åæ‰èƒ½è®¿é—®ã€‚è¿™æ ·å¯ä»¥é¿å…æ•°æ®ç«äº‰å’Œè„æ•°æ®é—®é¢˜ï¼Œä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚</span></p><p><strong><span>å¦‚ä½•æ‰èƒ½å®ç°å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®å‘¢ï¼Ÿ</span></strong><span> é”æ˜¯ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œæ›´å‡†ç¡®ç‚¹æ¥è¯´æ˜¯æ‚²è§‚é”ã€‚</span></p><p><span>æ‚²è§‚é”æ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œè®¤ä¸ºå…±äº«èµ„æºæ¯æ¬¡è¢«è®¿é—®çš„æ—¶å€™å°±ä¼šå‡ºç°é—®é¢˜(æ¯”å¦‚å…±äº«æ•°æ®è¢«ä¿®æ”¹)ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨è·å–èµ„æºæ“ä½œçš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹æƒ³æ‹¿åˆ°è¿™ä¸ªèµ„æºå°±ä¼šé˜»å¡ç›´åˆ°é”è¢«ä¸Šä¸€ä¸ªæŒæœ‰è€…é‡Šæ”¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ</span><strong><span>å…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹</span></strong><span>ã€‚</span></p><p><span>å¯¹äºå•æœºå¤šçº¿ç¨‹æ¥è¯´ï¼Œåœ¨ Java ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ </span><code>ReentrantLock</code><span> ç±»ã€</span><code>synchronized</code><span> å…³é”®å­—è¿™ç±» JDK è‡ªå¸¦çš„ </span><strong><span>æœ¬åœ°é”</span></strong><span> æ¥æ§åˆ¶ä¸€ä¸ª JVM è¿›ç¨‹å†…çš„å¤šä¸ªçº¿ç¨‹å¯¹æœ¬åœ°å…±äº«èµ„æºçš„è®¿é—®ã€‚</span></p><p><span>åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ï¼Œä¸åŒçš„æœåŠ¡/å®¢æˆ·ç«¯é€šå¸¸è¿è¡Œåœ¨ç‹¬ç«‹çš„ JVM è¿›ç¨‹ä¸Šã€‚å¦‚æœå¤šä¸ª JVM è¿›ç¨‹å…±äº«åŒä¸€ä»½èµ„æºçš„è¯ï¼Œä½¿ç”¨æœ¬åœ°é”å°±æ²¡åŠæ³•å®ç°èµ„æºçš„äº’æ–¥è®¿é—®äº†ã€‚äºæ˜¯ï¼Œ</span><strong><span>åˆ†å¸ƒå¼é”</span></strong><span> å°±è¯ç”Ÿäº†ã€‚</span></p><h2 id='åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å“ªäº›æ¡ä»¶'><span>åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å“ªäº›æ¡ä»¶ï¼Ÿ</span></h2><p><span>ä¸€ä¸ªæœ€åŸºæœ¬çš„åˆ†å¸ƒå¼é”éœ€è¦æ»¡è¶³ï¼š</span></p><ul><li><p><strong><span>äº’æ–¥</span></strong><span>ï¼šä»»æ„ä¸€ä¸ªæ—¶åˆ»ï¼Œé”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ã€‚</span></p></li><li><p><strong><span>é«˜å¯ç”¨</span></strong><span>ï¼šé”æœåŠ¡æ˜¯é«˜å¯ç”¨çš„ï¼Œå½“ä¸€ä¸ªé”æœåŠ¡å‡ºç°é—®é¢˜ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªé”æœåŠ¡ã€‚å¹¶ä¸”ï¼Œå³ä½¿å®¢æˆ·ç«¯çš„é‡Šæ”¾é”çš„ä»£ç é€»è¾‘å‡ºç°é—®é¢˜ï¼Œé”æœ€ç»ˆä¸€å®šè¿˜æ˜¯ä¼šè¢«é‡Šæ”¾ï¼Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚è¿™ä¸€èˆ¬æ˜¯é€šè¿‡è¶…æ—¶æœºåˆ¶å®ç°çš„ã€‚</span></p></li><li><p><strong><span>å¯é‡å…¥</span></strong><span>ï¼šä¸€ä¸ªèŠ‚ç‚¹è·å–äº†é”ä¹‹åï¼Œè¿˜å¯ä»¥å†æ¬¡è·å–é”ã€‚</span></p></li></ul><p><span>é™¤äº†ä¸Šé¢è¿™ä¸‰ä¸ªåŸºæœ¬æ¡ä»¶ä¹‹å¤–ï¼Œä¸€ä¸ªå¥½çš„åˆ†å¸ƒå¼é”è¿˜éœ€è¦æ»¡è¶³ä¸‹é¢è¿™äº›æ¡ä»¶ï¼š</span></p><ul><li><p><strong><span>é«˜æ€§èƒ½</span></strong><span>ï¼šè·å–å’Œé‡Šæ”¾é”çš„æ“ä½œåº”è¯¥å¿«é€Ÿå®Œæˆï¼Œå¹¶ä¸”ä¸åº”è¯¥å¯¹æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½é€ æˆè¿‡å¤§å½±å“ã€‚</span></p></li><li><p><strong><span>éé˜»å¡</span></strong><span>ï¼šå¦‚æœè·å–ä¸åˆ°é”ï¼Œä¸èƒ½æ— é™æœŸç­‰å¾…ï¼Œé¿å…å¯¹ç³»ç»Ÿæ­£å¸¸è¿è¡Œé€ æˆå½±å“ã€‚</span></p></li></ul><h2 id='åˆ†å¸ƒå¼é”çš„å¸¸è§å®ç°æ–¹å¼æœ‰å“ªäº›'><span>åˆ†å¸ƒå¼é”çš„å¸¸è§å®ç°æ–¹å¼æœ‰å“ªäº›ï¼Ÿ</span></h2><p><span>å¸¸è§åˆ†å¸ƒå¼é”å®ç°æ–¹æ¡ˆå¦‚ä¸‹ï¼š</span></p><ul><li><p><span>åŸºäºå…³ç³»å‹æ•°æ®åº“æ¯”å¦‚ MySQL å®ç°åˆ†å¸ƒå¼é”ã€‚</span></p></li><li><p><span>åŸºäºåˆ†å¸ƒå¼åè°ƒæœåŠ¡ ZooKeeper å®ç°åˆ†å¸ƒå¼é”ã€‚</span></p></li><li><p><span>åŸºäºåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿæ¯”å¦‚ Redis ã€Etcd å®ç°åˆ†å¸ƒå¼é”ã€‚</span></p></li></ul><p><span>å…³ç³»å‹æ•°æ®åº“çš„æ–¹å¼ä¸€èˆ¬æ˜¯é€šè¿‡å”¯ä¸€ç´¢å¼•æˆ–è€…æ’ä»–é”å®ç°ã€‚ä¸è¿‡ï¼Œä¸€èˆ¬ä¸ä¼šä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œé—®é¢˜å¤ªå¤šæ¯”å¦‚æ€§èƒ½å¤ªå·®ã€ä¸å…·å¤‡é”å¤±æ•ˆæœºåˆ¶ã€‚</span></p><h3 id='åŸºäº-redis-å®ç°åˆ†å¸ƒå¼é”'><span>åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”</span></h3><p><span>ä¸è®ºæ˜¯æœ¬åœ°é”è¿˜æ˜¯åˆ†å¸ƒå¼é”ï¼Œæ ¸å¿ƒéƒ½åœ¨äºâ€œäº’æ–¥â€ã€‚</span></p><p><span>åœ¨ Redis ä¸­ï¼Œ </span><code>SETNX</code><span> å‘½ä»¤æ˜¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°äº’æ–¥ã€‚</span><code>SETNX</code><span> å³ </span><strong><span>SET</span></strong><span> if </span><strong><span>N</span></strong><span>ot e</span><strong><span>X</span></strong><span>ists (å¯¹åº” Java ä¸­çš„ </span><code>setIfAbsent</code><span> æ–¹æ³•)ï¼Œå¦‚æœ key ä¸å­˜åœ¨çš„è¯ï¼Œæ‰ä¼šè®¾ç½® key çš„å€¼ã€‚å¦‚æœ key å·²ç»å­˜åœ¨ï¼Œ </span><code>SETNX</code><span> å•¥ä¹Ÿä¸åšã€‚</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">SETNX</span> <span class="cm-variable">lockKey</span> <span class="cm-variable">uniqueValue</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(<span class="cm-variable">integer</span>) <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">SETNX</span> <span class="cm-variable">lockKey</span> <span class="cm-variable">uniqueValue</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(<span class="cm-variable">integer</span>) <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre><p><span>é‡Šæ”¾é”çš„è¯ï¼Œç›´æ¥é€šè¿‡ </span><code>DEL</code><span> å‘½ä»¤åˆ é™¤å¯¹åº”çš„ key å³å¯ã€‚</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DEL</span> <span class="cm-variable">lockKey</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(<span class="cm-variable">integer</span>) <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p><span>è¿™æ˜¯ä¸€ç§æœ€ç®€æ˜“çš„ Redis åˆ†å¸ƒå¼é”å®ç°ï¼Œå®ç°æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œæ€§èƒ½ä¹Ÿå¾ˆé«˜æ•ˆã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼å®ç°åˆ†å¸ƒå¼é”å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚å°±æ¯”å¦‚åº”ç”¨ç¨‹åºé‡åˆ°ä¸€äº›é—®é¢˜æ¯”å¦‚é‡Šæ”¾é”çš„é€»è¾‘çªç„¶æŒ‚æ‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´é”æ— æ³•è¢«é‡Šæ”¾ï¼Œè¿›è€Œé€ æˆå…±äº«èµ„æºæ— æ³•å†è¢«å…¶ä»–çº¿ç¨‹/è¿›ç¨‹è®¿é—®ã€‚</span></p><p><span>ä¸ºäº†é¿å…é”æ— æ³•è¢«é‡Šæ”¾ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åˆ°çš„ä¸€ä¸ªè§£å†³åŠæ³•å°±æ˜¯ï¼š</span><strong><span>ç»™è¿™ä¸ª keyï¼ˆä¹Ÿå°±æ˜¯é”ï¼‰ è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´</span></strong><span> ã€‚</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">127.0</span>.<span class="cm-number">0.1</span>:<span class="cm-number">6379</span><span class="cm-operator">&gt;</span> <span class="cm-variable">SET</span> <span class="cm-variable">lockKey</span> <span class="cm-variable">uniqueValue</span> <span class="cm-variable">EX</span> <span class="cm-number">3</span> <span class="cm-variable">NX</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">OK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><ul><li><p><strong><span>lockKey</span></strong><span>ï¼šåŠ é”çš„é”åï¼›</span></p></li><li><p><strong><span>uniqueValue</span></strong><span>ï¼šèƒ½å¤Ÿå”¯ä¸€æ ‡è¯†é”çš„éšæœºå­—ç¬¦ä¸²ï¼›</span></p></li><li><p><strong><span>NX</span></strong><span>ï¼šåªæœ‰å½“ lockKey å¯¹åº”çš„ key å€¼ä¸å­˜åœ¨çš„æ—¶å€™æ‰èƒ½ SET æˆåŠŸï¼›</span></p></li><li><p><strong><span>EX</span></strong><span>ï¼šè¿‡æœŸæ—¶é—´è®¾ç½®ï¼ˆç§’ä¸ºå•ä½ï¼‰EX 3 æ ‡ç¤ºè¿™ä¸ªé”æœ‰ä¸€ä¸ª 3 ç§’çš„è‡ªåŠ¨è¿‡æœŸæ—¶é—´ã€‚ä¸ EX å¯¹åº”çš„æ˜¯ PXï¼ˆæ¯«ç§’ä¸ºå•ä½ï¼‰ï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯è¿‡æœŸæ—¶é—´è®¾ç½®ã€‚</span></p></li></ul><p><strong><span>ä¸€å®šè¦ä¿è¯è®¾ç½®æŒ‡å®š key çš„å€¼å’Œè¿‡æœŸæ—¶é—´æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼ï¼ï¼</span></strong><span> ä¸ç„¶çš„è¯ï¼Œä¾ç„¶å¯èƒ½ä¼šå‡ºç°é”æ— æ³•è¢«é‡Šæ”¾çš„é—®é¢˜ã€‚</span></p><p><span>è¿™æ ·ç¡®å®å¯ä»¥è§£å†³é—®é¢˜ï¼Œä¸è¿‡ï¼Œè¿™ç§è§£å†³åŠæ³•åŒæ ·å­˜åœ¨æ¼æ´ï¼š</span><strong><span>å¦‚æœæ“ä½œå…±äº«èµ„æºçš„æ—¶é—´å¤§äºè¿‡æœŸæ—¶é—´ï¼Œå°±ä¼šå‡ºç°é”æå‰è¿‡æœŸçš„é—®é¢˜ï¼Œè¿›è€Œå¯¼è‡´åˆ†å¸ƒå¼é”ç›´æ¥å¤±æ•ˆã€‚å¦‚æœé”çš„è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡é•¿ï¼Œåˆä¼šå½±å“åˆ°æ€§èƒ½ã€‚</span></strong></p><p><span>ä½ æˆ–è®¸åœ¨æƒ³ï¼š</span><strong><span>å¦‚æœæ“ä½œå…±äº«èµ„æºçš„æ“ä½œè¿˜æœªå®Œæˆï¼Œé”è¿‡æœŸæ—¶é—´èƒ½å¤Ÿè‡ªå·±ç»­æœŸå°±å¥½äº†ï¼</span></strong><span>å·²ç»æœ‰äº†ç°æˆçš„è§£å†³æ–¹æ¡ˆï¼š</span><strong><a href='https://github.com/redisson/redisson'><span>Redisson</span></a></strong></p><p><span>Redisson æ˜¯ä¸€ä¸ªå¼€æºçš„ Java è¯­è¨€ Redis å®¢æˆ·ç«¯ï¼Œæä¾›äº†å¾ˆå¤šå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼Œä¸ä»…ä»…åŒ…æ‹¬å¤šç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚å¹¶ä¸”ï¼ŒRedisson è¿˜æ”¯æŒ Redis å•æœºã€Redis Sentinelã€Redis Cluster ç­‰å¤šç§éƒ¨ç½²æ¶æ„ã€‚</span></p><p><span>Redisson ä¸­çš„åˆ†å¸ƒå¼é”è‡ªå¸¦è‡ªåŠ¨ç»­æœŸæœºåˆ¶ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼ŒåŸç†ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå…¶æä¾›äº†ä¸€ä¸ªä¸“é—¨ç”¨æ¥ç›‘æ§å’Œç»­æœŸé”çš„ </span><strong><span>Watch Dogï¼ˆ çœ‹é—¨ç‹—ï¼‰</span></strong><span>ï¼Œå¦‚æœæ“ä½œå…±äº«èµ„æºçš„çº¿ç¨‹è¿˜æœªæ‰§è¡Œå®Œæˆçš„è¯ï¼ŒWatch Dog ä¼šä¸æ–­åœ°å»¶é•¿é”çš„è¿‡æœŸæ—¶é—´ï¼Œè¿›è€Œä¿è¯é”ä¸ä¼šå› ä¸ºè¶…æ—¶è€Œè¢«é‡Šæ”¾ã€‚</span></p><p><strong><span>Redis å¦‚ä½•è§£å†³é›†ç¾¤æƒ…å†µä¸‹åˆ†å¸ƒå¼é”çš„å¯é æ€§ï¼Ÿ</span></strong></p><p><span>ä¸ºäº†é¿å…å•ç‚¹æ•…éšœï¼Œç”Ÿäº§ç¯å¢ƒä¸‹çš„ Redis æœåŠ¡é€šå¸¸æ˜¯é›†ç¾¤åŒ–éƒ¨ç½²çš„ã€‚</span></p><p><span>Redis é›†ç¾¤ä¸‹ï¼Œä¸Šé¢ä»‹ç»åˆ°çš„åˆ†å¸ƒå¼é”çš„å®ç°ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚ç”±äº Redis é›†ç¾¤æ•°æ®åŒæ­¥åˆ°å„ä¸ªèŠ‚ç‚¹æ—¶æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœåœ¨ Redis ä¸»èŠ‚ç‚¹è·å–åˆ°é”åï¼Œåœ¨æ²¡æœ‰åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹æ—¶ï¼ŒRedis ä¸»èŠ‚ç‚¹å®•æœºäº†ï¼Œæ­¤æ—¶æ–°çš„ Redis ä¸»èŠ‚ç‚¹ä¾ç„¶å¯ä»¥è·å–é”ï¼Œæ‰€ä»¥å¤šä¸ªåº”ç”¨æœåŠ¡å°±å¯ä»¥åŒæ—¶è·å–åˆ°é”ã€‚</span></p><p><span>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒRedis ä¹‹çˆ¶ antirez è®¾è®¡äº† </span><a href='https://redis.io/topics/distlock'><span>Redlock ç®—æ³•open in new window</span></a><span> æ¥è§£å†³ã€‚</span></p><p><span>Redlock ç®—æ³•çš„æ€æƒ³æ˜¯è®©å®¢æˆ·ç«¯å‘ Redis é›†ç¾¤ä¸­çš„å¤šä¸ªç‹¬ç«‹çš„ Redis å®ä¾‹ä¾æ¬¡è¯·æ±‚ç”³è¯·åŠ é”ï¼Œå¦‚æœå®¢æˆ·ç«¯èƒ½å¤Ÿå’ŒåŠæ•°ä»¥ä¸Šçš„å®ä¾‹æˆåŠŸåœ°å®ŒæˆåŠ é”æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºï¼Œå®¢æˆ·ç«¯æˆåŠŸåœ°è·å¾—åˆ†å¸ƒå¼é”ï¼Œå¦åˆ™åŠ é”å¤±è´¥ã€‚</span></p><p><span>å³ä½¿éƒ¨åˆ† Redis èŠ‚ç‚¹å‡ºç°é—®é¢˜ï¼Œåªè¦ä¿è¯ Redis é›†ç¾¤ä¸­æœ‰åŠæ•°ä»¥ä¸Šçš„ Redis èŠ‚ç‚¹å¯ç”¨ï¼Œåˆ†å¸ƒå¼é”æœåŠ¡å°±æ˜¯æ­£å¸¸çš„ã€‚</span></p><p><span>Redlock æ˜¯ç›´æ¥æ“ä½œ Redis èŠ‚ç‚¹Redlock å®ç°æ¯”è¾ƒå¤æ‚ï¼Œæ€§èƒ½æ¯”è¾ƒå·®ï¼Œå‘ç”Ÿæ—¶é’Ÿå˜è¿çš„æƒ…å†µä¸‹è¿˜å­˜åœ¨å®‰å…¨æ€§éšæ‚£ã€‚ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ä¸€ä¹¦çš„ä½œè€… Martin Kleppmann æ›¾ç»ä¸“é—¨å‘æ–‡ï¼ˆ</span><a href='https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html'><span>How to do distributed locking - Martin Kleppmann - 2016open in new window</span></a><span>ï¼‰æ€¼è¿‡ Redlockï¼Œä»–è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¾ˆå·®çš„åˆ†å¸ƒå¼é”å®ç°ã€‚æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹çœ‹</span><a href='https://mp.weixin.qq.com/s?__biz=Mzg3NjU3NTkwMQ==&amp;mid=2247505097&amp;idx=1&amp;sn=5c03cb769c4458350f4d4a321ad51f5a&amp;source=41#wechat_redirect'><span>Redis é”ä»é¢è¯•è¿ç¯ç‚®èŠåˆ°ç¥ä»™æ‰“æ¶open in new window</span></a><span>è¿™ç¯‡æ–‡ç« ï¼Œæœ‰è¯¦ç»†ä»‹ç»åˆ° antirez å’Œ Martin Kleppmann å…³äº Redlock çš„æ¿€çƒˆè¾©è®ºã€‚</span></p><p><span>å®é™…é¡¹ç›®ä¸­ä¸å»ºè®®ä½¿ç”¨ Redlock ç®—æ³•ï¼Œæˆæœ¬å’Œæ”¶ç›Šä¸æˆæ­£æ¯”ã€‚</span></p><p><span>å¦‚æœä¸æ˜¯éè¦å®ç°ç»å¯¹å¯é çš„åˆ†å¸ƒå¼é”çš„è¯ï¼Œå…¶å®å•æœºç‰ˆ Redis å°±å®Œå…¨å¤Ÿäº†ï¼Œå®ç°ç®€å•ï¼Œæ€§èƒ½ä¹Ÿéå¸¸é«˜ã€‚å¦‚æœä½ å¿…é¡»è¦å®ç°ä¸€ä¸ªç»å¯¹å¯é çš„åˆ†å¸ƒå¼é”çš„è¯ï¼Œå¯ä»¥åŸºäº ZooKeeper æ¥åšï¼Œåªæ˜¯æ€§èƒ½ä¼šå·®ä¸€äº›ã€‚</span></p><ul><li><p><strong><span>å¦‚ä½•å®ç°å¯é‡å…¥é”ï¼Ÿ</span></strong></p></li></ul><p><span>æ‰€è°“å¯é‡å…¥é”æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼Œæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œä¸€ä¸ªå¸¦é”çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­åˆè°ƒç”¨äº†å¦ä¸€ä¸ªéœ€è¦ç›¸åŒé”çš„æ–¹æ³•ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥ç›´æ¥æ‰§è¡Œè°ƒç”¨çš„æ–¹æ³•å³å¯é‡å…¥ ï¼Œè€Œæ— éœ€é‡æ–°è·å¾—é”ã€‚åƒ Java ä¸­çš„ </span><code>synchronized</code><span> å’Œ </span><code>ReentrantLock</code><span> éƒ½å±äºå¯é‡å…¥é”ã€‚</span></p><p><strong><span>ä¸å¯é‡å…¥çš„åˆ†å¸ƒå¼é”åŸºæœ¬å¯ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯äº†ï¼Œä¸€äº›ç‰¹æ®Šçš„åœºæ™¯å¯èƒ½ä¼šéœ€è¦ä½¿ç”¨å¯é‡å…¥çš„åˆ†å¸ƒå¼é”ã€‚</span></strong></p><p><span>å¯é‡å…¥åˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯æ˜¯çº¿ç¨‹åœ¨è·å–é”çš„æ—¶å€™åˆ¤æ–­æ˜¯å¦ä¸ºè‡ªå·±çš„é”ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¸ç”¨å†é‡æ–°è·å–äº†ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªé”å…³è”ä¸€ä¸ªå¯é‡å…¥è®¡æ•°å™¨å’Œä¸€ä¸ªå æœ‰å®ƒçš„çº¿ç¨‹ã€‚å½“å¯é‡å…¥è®¡æ•°å™¨å¤§äº 0 æ—¶ï¼Œåˆ™é”è¢«å æœ‰ï¼Œéœ€è¦åˆ¤æ–­å æœ‰è¯¥é”çš„çº¿ç¨‹å’Œè¯·æ±‚è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºåŒä¸€ä¸ªã€‚</span></p><p><span>å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨å®ç°ï¼Œæ¨èä½¿ç”¨æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ </span><strong><span>Redisson</span></strong><span> ï¼Œå…¶å†…ç½®äº†å¤šç§ç±»å‹çš„é”æ¯”å¦‚å¯é‡å…¥é”ï¼ˆReentrant Lockï¼‰ã€è‡ªæ—‹é”ï¼ˆSpin Lockï¼‰ã€å…¬å¹³é”ï¼ˆFair Lockï¼‰ã€å¤šé‡é”ï¼ˆMultiLockï¼‰ã€ çº¢é”ï¼ˆRedLockï¼‰ã€ è¯»å†™é”ï¼ˆReadWriteLockï¼‰ã€‚</span></p><h3 id='åŸºäº-zookeeper-å®ç°åˆ†å¸ƒå¼é”'><span>åŸºäº ZooKeeper å®ç°åˆ†å¸ƒå¼é”</span></h3><p><span>ZooKeeper åˆ†å¸ƒå¼é”æ˜¯åŸºäº </span><strong><span>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹</span></strong><span> å’Œ </span><strong><span>Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰</span></strong><span> å®ç°çš„ã€‚</span></p><p><strong><span>è·å–é”ï¼š</span></strong></p><ol start='' ><li><p><span>é¦–å…ˆæˆ‘ä»¬è¦æœ‰ä¸€ä¸ªæŒä¹…èŠ‚ç‚¹</span><code>/locks</code><span>ï¼Œå®¢æˆ·ç«¯è·å–é”å°±æ˜¯åœ¨</span><code>locks</code><span>ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ã€‚</span></p></li><li><p><span>å‡è®¾å®¢æˆ·ç«¯ 1 åˆ›å»ºäº†</span><code>/locks/lock1</code><span>èŠ‚ç‚¹ï¼Œåˆ›å»ºæˆåŠŸä¹‹åï¼Œä¼šåˆ¤æ–­ </span><code>lock1</code><span>æ˜¯å¦æ˜¯ </span><code>/locks</code><span> ä¸‹æœ€å°çš„å­èŠ‚ç‚¹ã€‚</span></p></li><li><p><span>å¦‚æœ </span><code>lock1</code><span>æ˜¯æœ€å°çš„å­èŠ‚ç‚¹ï¼Œåˆ™è·å–é”æˆåŠŸã€‚å¦åˆ™ï¼Œè·å–é”å¤±è´¥ã€‚</span></p></li><li><p><span>å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™è¯´æ˜æœ‰å…¶ä»–çš„å®¢æˆ·ç«¯å·²ç»æˆåŠŸè·å–é”ã€‚å®¢æˆ·ç«¯ 1 å¹¶ä¸ä¼šä¸åœåœ°å¾ªç¯å»å°è¯•åŠ é”ï¼Œè€Œæ˜¯åœ¨å‰ä¸€ä¸ªèŠ‚ç‚¹æ¯”å¦‚</span><code>/locks/lock0</code><span>ä¸Šæ³¨å†Œä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ã€‚è¿™ä¸ªç›‘å¬å™¨çš„ä½œç”¨æ˜¯å½“å‰ä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾é”ä¹‹åé€šçŸ¥å®¢æˆ·ç«¯ 1ï¼ˆé¿å…æ— æ•ˆè‡ªæ—‹ï¼‰ï¼Œè¿™æ ·å®¢æˆ·ç«¯ 1 å°±åŠ é”æˆåŠŸäº†ã€‚</span></p></li></ol><p><strong><span>é‡Šæ”¾é”ï¼š</span></strong></p><ol start='' ><li><p><span>æˆåŠŸè·å–é”çš„å®¢æˆ·ç«¯åœ¨æ‰§è¡Œå®Œä¸šåŠ¡æµç¨‹ä¹‹åï¼Œä¼šå°†å¯¹åº”çš„å­èŠ‚ç‚¹åˆ é™¤ã€‚</span></p></li><li><p><span>æˆåŠŸè·å–é”çš„å®¢æˆ·ç«¯åœ¨å‡ºç°æ•…éšœä¹‹åï¼Œå¯¹åº”çš„å­èŠ‚ç‚¹ç”±äºæ˜¯ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œä¹Ÿä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼Œé¿å…äº†é”æ— æ³•è¢«é‡Šæ”¾ã€‚</span></p></li><li><p><span>æˆ‘ä»¬å‰é¢è¯´çš„äº‹ä»¶ç›‘å¬å™¨å…¶å®ç›‘å¬çš„å°±æ˜¯è¿™ä¸ªå­èŠ‚ç‚¹åˆ é™¤äº‹ä»¶ï¼Œå­èŠ‚ç‚¹åˆ é™¤å°±æ„å‘³ç€é”è¢«é‡Šæ”¾ã€‚</span></p></li></ol><p><img src="assets/image-20240621165356838.png" referrerpolicy="no-referrer" alt="image-20240621165356838"></p><p><span>å®é™…é¡¹ç›®ä¸­ï¼Œæ¨èä½¿ç”¨ Curator æ¥å®ç° ZooKeeper åˆ†å¸ƒå¼é”ã€‚Curator æ˜¯ Netflix å…¬å¸å¼€æºçš„ä¸€å¥— ZooKeeper Java å®¢æˆ·ç«¯æ¡†æ¶ï¼Œç›¸æ¯”äº ZooKeeper è‡ªå¸¦çš„å®¢æˆ·ç«¯ zookeeper æ¥è¯´ï¼ŒCurator çš„å°è£…æ›´åŠ å®Œå–„ï¼Œå„ç§ API éƒ½å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿åœ°ä½¿ç”¨ã€‚</span></p><p><code>Curator</code><span>ä¸»è¦å®ç°äº†ä¸‹é¢å››ç§é”ï¼š</span></p><ul><li><p><code>InterProcessMutex</code><span>ï¼šåˆ†å¸ƒå¼å¯é‡å…¥æ’å®ƒé”</span></p></li><li><p><code>InterProcessSemaphoreMutex</code><span>ï¼šåˆ†å¸ƒå¼ä¸å¯é‡å…¥æ’å®ƒé”</span></p></li><li><p><code>InterProcessReadWriteLock</code><span>ï¼šåˆ†å¸ƒå¼è¯»å†™é”</span></p></li><li><p><code>InterProcessMultiLock</code><span>ï¼šå°†å¤šä¸ªé”ä½œä¸ºå•ä¸ªå®ä½“ç®¡ç†çš„å®¹å™¨ï¼Œè·å–é”çš„æ—¶å€™è·å–æ‰€æœ‰é”ï¼Œé‡Šæ”¾é”ä¹Ÿä¼šé‡Šæ”¾æ‰€æœ‰é”èµ„æºï¼ˆå¿½ç•¥é‡Šæ”¾å¤±è´¥çš„é”ï¼‰ã€‚</span></p></li><li><p><strong><span>ä¸ºä»€ä¹ˆè¦ç”¨ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Ÿ</span></strong></p></li></ul><p><span>æ¯ä¸ªæ•°æ®èŠ‚ç‚¹åœ¨ ZooKeeper ä¸­è¢«ç§°ä¸º </span><strong><span>znode</span></strong><span>ï¼Œå®ƒæ˜¯ ZooKeeper ä¸­æ•°æ®çš„æœ€å°å•å…ƒã€‚</span></p><p><span>æˆ‘ä»¬é€šå¸¸æ˜¯å°† znode åˆ†ä¸º 4 å¤§ç±»ï¼š</span></p><ul><li><p><strong><span>æŒä¹…ï¼ˆPERSISTENTï¼‰èŠ‚ç‚¹</span></strong><span>ï¼šä¸€æ—¦åˆ›å»ºå°±ä¸€ç›´å­˜åœ¨å³ä½¿ ZooKeeper é›†ç¾¤å®•æœºï¼Œç›´åˆ°å°†å…¶åˆ é™¤ã€‚</span></p></li><li><p><strong><span>ä¸´æ—¶ï¼ˆEPHEMERALï¼‰èŠ‚ç‚¹</span></strong><span>ï¼šä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ </span><strong><span>å®¢æˆ·ç«¯ä¼šè¯ï¼ˆsessionï¼‰</span></strong><span> ç»‘å®šçš„ï¼Œ</span><strong><span>ä¼šè¯æ¶ˆå¤±åˆ™èŠ‚ç‚¹æ¶ˆå¤±</span></strong><span> ã€‚å¹¶ä¸”ï¼Œ</span><strong><span>ä¸´æ—¶èŠ‚ç‚¹åªèƒ½åšå¶å­èŠ‚ç‚¹</span></strong><span> ï¼Œä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ã€‚</span></p></li><li><p><strong><span>æŒä¹…é¡ºåºï¼ˆPERSISTENT_SEQUENTIALï¼‰èŠ‚ç‚¹</span></strong><span>ï¼šé™¤äº†å…·æœ‰æŒä¹…ï¼ˆPERSISTENTï¼‰èŠ‚ç‚¹çš„ç‰¹æ€§ä¹‹å¤–ï¼Œ å­èŠ‚ç‚¹çš„åç§°è¿˜å…·æœ‰é¡ºåºæ€§ã€‚æ¯”å¦‚ </span><code>/node1/app0000000001</code><span>ã€</span><code>/node1/app0000000002</code><span> ã€‚</span></p></li><li><p><strong><span>ä¸´æ—¶é¡ºåºï¼ˆEPHEMERAL_SEQUENTIALï¼‰èŠ‚ç‚¹</span></strong><span>ï¼šé™¤äº†å…·å¤‡ä¸´æ—¶ï¼ˆEPHEMERALï¼‰èŠ‚ç‚¹çš„ç‰¹æ€§ä¹‹å¤–ï¼Œå­èŠ‚ç‚¹çš„åç§°è¿˜å…·æœ‰é¡ºåºæ€§ã€‚</span></p></li></ul><p><span>å¯ä»¥çœ‹å‡ºï¼Œä¸´æ—¶èŠ‚ç‚¹ç›¸æ¯”æŒä¹…èŠ‚ç‚¹ï¼Œæœ€ä¸»è¦çš„æ˜¯å¯¹ä¼šè¯å¤±æ•ˆçš„æƒ…å†µå¤„ç†ä¸ä¸€æ ·ï¼Œä¸´æ—¶èŠ‚ç‚¹ä¼šè¯æ¶ˆå¤±åˆ™å¯¹åº”çš„èŠ‚ç‚¹æ¶ˆå¤±ã€‚è¿™æ ·çš„è¯ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸å¯¼è‡´æ²¡æ¥å¾—åŠé‡Šæ”¾é”ä¹Ÿæ²¡å…³ç³»ï¼Œä¼šè¯å¤±æ•ˆèŠ‚ç‚¹è‡ªåŠ¨è¢«åˆ é™¤ï¼Œä¸ä¼šå‘ç”Ÿæ­»é”çš„é—®é¢˜ã€‚</span></p><p><span>ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡è¿‡æœŸæ—¶é—´æ¥é¿å…é”æ— æ³•è¢«é‡Šæ”¾å¯¼è‡´æ­»é”é—®é¢˜çš„ï¼Œè€Œ ZooKeeper ç›´æ¥åˆ©ç”¨ä¸´æ—¶èŠ‚ç‚¹çš„ç‰¹æ€§å³å¯ã€‚</span></p><p><span>å‡è®¾ä¸ä½¿ç”¨é¡ºåºèŠ‚ç‚¹çš„è¯ï¼Œæ‰€æœ‰å°è¯•è·å–é”çš„å®¢æˆ·ç«¯éƒ½ä¼šå¯¹æŒæœ‰é”çš„å­èŠ‚ç‚¹åŠ ç›‘å¬å™¨ã€‚å½“è¯¥é”è¢«é‡Šæ”¾ä¹‹åï¼ŒåŠ¿å¿…ä¼šé€ æˆæ‰€æœ‰å°è¯•è·å–é”çš„å®¢æˆ·ç«¯æ¥äº‰å¤ºé”ï¼Œè¿™æ ·å¯¹æ€§èƒ½ä¸å‹å¥½ã€‚ä½¿ç”¨é¡ºåºèŠ‚ç‚¹ä¹‹åï¼Œåªéœ€è¦ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹å°±å¥½äº†ï¼Œå¯¹æ€§èƒ½æ›´å‹å¥½ã€‚</span></p><ul><li><p><strong><span>ä¸ºä»€ä¹ˆè¦è®¾ç½®å¯¹å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ç›‘å¬ï¼Ÿ</span></strong></p></li></ul><blockquote><p><span>Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰ï¼Œæ˜¯ ZooKeeper ä¸­çš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§ã€‚ZooKeeper å…è®¸ç”¨æˆ·åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€äº› Watcherï¼Œå¹¶ä¸”åœ¨ä¸€äº›ç‰¹å®šäº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼ŒZooKeeper æœåŠ¡ç«¯ä¼šå°†äº‹ä»¶é€šçŸ¥åˆ°æ„Ÿå…´è¶£çš„å®¢æˆ·ç«¯ä¸Šå»ï¼Œè¯¥æœºåˆ¶æ˜¯ ZooKeeper å®ç°åˆ†å¸ƒå¼åè°ƒæœåŠ¡çš„é‡è¦ç‰¹æ€§ã€‚</span></p></blockquote><p><span>åŒä¸€æ—¶é—´æ®µå†…ï¼Œå¯èƒ½ä¼šæœ‰å¾ˆå¤šå®¢æˆ·ç«¯åŒæ—¶è·å–é”ï¼Œä½†åªæœ‰ä¸€ä¸ªå¯ä»¥è·å–æˆåŠŸã€‚å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™è¯´æ˜æœ‰å…¶ä»–çš„å®¢æˆ·ç«¯å·²ç»æˆåŠŸè·å–é”ã€‚è·å–é”å¤±è´¥çš„å®¢æˆ·ç«¯å¹¶ä¸ä¼šä¸åœåœ°å¾ªç¯å»å°è¯•åŠ é”ï¼Œè€Œæ˜¯åœ¨å‰ä¸€ä¸ªèŠ‚ç‚¹æ³¨å†Œä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ã€‚</span></p><p><span>è¿™ä¸ªäº‹ä»¶ç›‘å¬å™¨çš„ä½œç”¨æ˜¯ï¼š</span><strong><span>å½“å‰ä¸€ä¸ªèŠ‚ç‚¹å¯¹åº”çš„å®¢æˆ·ç«¯é‡Šæ”¾é”ä¹‹åï¼ˆä¹Ÿå°±æ˜¯å‰ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤ä¹‹åï¼Œç›‘å¬çš„æ˜¯åˆ é™¤äº‹ä»¶ï¼‰ï¼Œé€šçŸ¥è·å–é”å¤±è´¥çš„å®¢æˆ·ç«¯ï¼ˆå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼ŒJava ä¸­çš„ </span><code>wait/notifyAll</code><span> ï¼‰ï¼Œè®©å®ƒå°è¯•å»è·å–é”ï¼Œç„¶åå°±æˆåŠŸè·å–é”äº†ã€‚</span></strong></p><ul><li><p><strong><span>å¦‚ä½•å®ç°å¯é‡å…¥é”</span></strong></p><p><span>è¿™é‡Œä»¥ Curator çš„ </span><code>InterProcessMutex</code><span> å¯¹å¯é‡å…¥é”çš„å®ç°æ¥ä»‹ç»ï¼ˆæºç åœ°å€ï¼š</span><a href='https://github.com/apache/curator/blob/master/curator-recipes/src/main/java/org/apache/curator/framework/recipes/locks/InterProcessMutex.java'><span>InterProcessMutex.javaopen in new window</span></a><span>ï¼‰ã€‚</span></p><p><span>å½“æˆ‘ä»¬è°ƒç”¨ </span><code>InterProcessMutex#acquire</code><span>æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨</span><code>InterProcessMutex#internalLock</code><span>æ–¹æ³•ã€‚</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// è·å–å¯é‡å…¥äº’æ–¥é”ï¼Œç›´åˆ°è·å–æˆåŠŸä¸ºæ­¢</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">acquire</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">internalLock</span>(<span class="cm-operator">-</span><span class="cm-number">1</span>, <span class="cm-atom">null</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">IOException</span>(<span class="cm-string">"Lost connection while trying to acquire lock: "</span> <span class="cm-operator">+</span> <span class="cm-variable">basePath</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 184px;"></div><div class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre><p><code>internalLock</code><span> æ–¹æ³•ä¼šå…ˆè·å–å½“å‰è¯·æ±‚é”çš„çº¿ç¨‹ï¼Œç„¶åä» </span><code>threadData</code><span>( </span><code>ConcurrentMap&lt;Thread, LockData&gt;</code><span> ç±»å‹)ä¸­è·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„ </span><code>lockData</code><span> ã€‚ </span><code>lockData</code><span> åŒ…å«é”çš„ä¿¡æ¯å’ŒåŠ é”çš„æ¬¡æ•°ï¼Œæ˜¯å®ç°å¯é‡å…¥é”çš„å…³é”®ã€‚</span></p><p><span>ç¬¬ä¸€æ¬¡è·å–é”çš„æ—¶å€™ï¼Œ</span><code>lockData</code><span>ä¸º </span><code>null</code><span>ã€‚è·å–é”æˆåŠŸä¹‹åï¼Œä¼šå°†å½“å‰çº¿ç¨‹å’Œå¯¹åº”çš„ </span><code>lockData</code><span> æ”¾åˆ° </span><code>threadData</code><span> ä¸­</span></p><p><span>å¦‚æœå·²ç»è·å–è¿‡ä¸€æ¬¡é”ï¼Œåé¢å†æ¥è·å–é”çš„è¯ï¼Œç›´æ¥å°±ä¼šåœ¨ </span><code>if (lockData != null)</code><span> è¿™é‡Œè¢«æ‹¦ä¸‹äº†ï¼Œç„¶åå°±ä¼šæ‰§è¡Œ</span><code>lockData.lockCount.incrementAndGet();</code><span> å°†åŠ é”æ¬¡æ•°åŠ  1ã€‚</span></p><p><span>æ•´ä¸ªå¯é‡å…¥é”çš„å®ç°é€»è¾‘éå¸¸ç®€å•ï¼Œç›´æ¥åœ¨å®¢æˆ·ç«¯åˆ¤æ–­å½“å‰çº¿ç¨‹æœ‰æ²¡æœ‰è·å–é”ï¼Œæœ‰çš„è¯ç›´æ¥å°†åŠ é”æ¬¡æ•°åŠ  1 å°±å¯ä»¥äº†ã€‚</span></p></li></ul><h2 id='åˆ†å¸ƒå¼é”çš„é€‰æ‹©'><span>åˆ†å¸ƒå¼é”çš„é€‰æ‹©</span></h2><p><span>å¦‚æœå¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„è¯ï¼Œå»ºè®®ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”ï¼ˆä¼˜å…ˆé€‰æ‹© Redisson æä¾›çš„ç°æˆçš„åˆ†å¸ƒå¼é”ï¼Œè€Œä¸æ˜¯è‡ªå·±å®ç°ï¼‰ã€‚</span></p><p><span>å¦‚æœå¯¹å¯é æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„è¯ï¼Œå»ºè®®ä½¿ç”¨ ZooKeeper å®ç°åˆ†å¸ƒå¼é”ï¼ˆæ¨èåŸºäº Curator æ¡†æ¶å®ç°ï¼‰ã€‚ä¸è¿‡ï¼Œç°åœ¨å¾ˆå¤šé¡¹ç›®éƒ½ä¸ä¼šç”¨åˆ° ZooKeeperï¼Œå¦‚æœå•çº¯æ˜¯å› ä¸ºåˆ†å¸ƒå¼é”è€Œå¼•å…¥ ZooKeeper çš„è¯ï¼Œé‚£æ˜¯ä¸å¤ªå¯å–çš„ï¼Œä¸å»ºè®®è¿™æ ·åšï¼Œä¸ºäº†ä¸€ä¸ªå°å°çš„åŠŸèƒ½å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚</span></p><h1 id='ä¸‰åˆ†å¸ƒå¼id'><span>ä¸‰ã€åˆ†å¸ƒå¼ID </span></h1><h3 id='ä»€ä¹ˆæ˜¯-id'><span>ä»€ä¹ˆæ˜¯ IDï¼Ÿ</span></h3><p><span>æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ç³»ç»Ÿä¸­çš„å„ç§æ•°æ®ä½¿ç”¨ ID å”¯ä¸€è¡¨ç¤ºï¼Œæ¯”å¦‚ç”¨æˆ· ID å¯¹åº”ä¸”ä»…å¯¹åº”ä¸€ä¸ªäººï¼Œå•†å“ ID å¯¹åº”ä¸”ä»…å¯¹åº”ä¸€ä»¶å•†å“ï¼Œè®¢å• ID å¯¹åº”ä¸”ä»…å¯¹åº”ä¸€ä¸ªè®¢å•ã€‚</span></p><p><span>æˆ‘ä»¬ç°å®ç”Ÿæ´»ä¸­ä¹Ÿæœ‰å„ç§ IDï¼Œæ¯”å¦‚èº«ä»½è¯ ID å¯¹åº”ä¸”ä»…å¯¹åº”ä¸€ä¸ªäººã€åœ°å€ ID å¯¹åº”ä¸”ä»…å¯¹åº”ä¸€ä¸ªåœ°å€ã€‚</span></p><p><span>ç®€å•æ¥è¯´ï¼Œ</span><strong><span>ID å°±æ˜¯æ•°æ®çš„å”¯ä¸€æ ‡è¯†</span></strong><span>ã€‚</span></p><h3 id='ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼-id'><span>ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ IDï¼Ÿ</span></h3><p><span>åˆ†å¸ƒå¼ ID æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹çš„ IDã€‚åˆ†å¸ƒå¼ ID ä¸å­˜åœ¨ä¸ç°å®ç”Ÿæ´»ä¸­ï¼Œå±äºè®¡ç®—æœºç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ¦‚å¿µã€‚</span></p><p><span>æˆ‘ç®€å•ä¸¾ä¸€ä¸ªåˆ†åº“åˆ†è¡¨çš„ä¾‹å­ã€‚</span></p><p><span>æˆ‘å¸çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä½¿ç”¨çš„æ˜¯å•æœº MySQL ã€‚ä½†æ˜¯ï¼Œæ²¡æƒ³åˆ°çš„æ˜¯ï¼Œé¡¹ç›®ä¸Šçº¿ä¸€ä¸ªæœˆä¹‹åï¼Œéšç€ä½¿ç”¨äººæ•°è¶Šæ¥è¶Šå¤šï¼Œæ•´ä¸ªç³»ç»Ÿçš„æ•°æ®é‡å°†è¶Šæ¥è¶Šå¤§ã€‚å•æœº MySQL å·²ç»æ²¡åŠæ³•æ”¯æ’‘äº†ï¼Œéœ€è¦è¿›è¡Œåˆ†åº“åˆ†è¡¨ï¼ˆæ¨è Sharding-JDBCï¼‰ã€‚</span></p><p><span>åœ¨åˆ†åº“ä¹‹åï¼Œ æ•°æ®éå¸ƒåœ¨ä¸åŒæœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“ï¼Œæ•°æ®åº“çš„è‡ªå¢ä¸»é”®å·²ç»æ²¡åŠæ³•æ»¡è¶³ç”Ÿæˆçš„ä¸»é”®å”¯ä¸€äº†ã€‚</span><strong><span>æˆ‘ä»¬å¦‚ä½•ä¸ºä¸åŒçš„æ•°æ®èŠ‚ç‚¹ç”Ÿæˆå…¨å±€å”¯ä¸€ä¸»é”®å‘¢ï¼Ÿ</span></strong></p><p><span>è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”Ÿæˆ</span><strong><span>åˆ†å¸ƒå¼ ID</span></strong><span>äº†ã€‚</span></p><h3 id='åˆ†å¸ƒå¼-id-éœ€è¦æ»¡è¶³å“ªäº›è¦æ±‚'><span>åˆ†å¸ƒå¼ ID éœ€è¦æ»¡è¶³å“ªäº›è¦æ±‚?</span></h3><p><span>åˆ†å¸ƒå¼ ID ä½œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½è¦ç”¨åˆ°åˆ†å¸ƒå¼ IDã€‚</span></p><p><span>ä¸€ä¸ªæœ€åŸºæœ¬çš„åˆ†å¸ƒå¼ ID éœ€è¦æ»¡è¶³ä¸‹é¢è¿™äº›è¦æ±‚ï¼š</span></p><ul><li><p><strong><span>å…¨å±€å”¯ä¸€</span></strong><span>ï¼šID çš„å…¨å±€å”¯ä¸€æ€§è‚¯å®šæ˜¯é¦–å…ˆè¦æ»¡è¶³çš„ï¼</span></p></li><li><p><strong><span>é«˜æ€§èƒ½</span></strong><span>ï¼šåˆ†å¸ƒå¼ ID çš„ç”Ÿæˆé€Ÿåº¦è¦å¿«ï¼Œå¯¹æœ¬åœ°èµ„æºæ¶ˆè€—è¦å°ã€‚</span></p></li><li><p><strong><span>é«˜å¯ç”¨</span></strong><span>ï¼šç”Ÿæˆåˆ†å¸ƒå¼ ID çš„æœåŠ¡è¦ä¿è¯å¯ç”¨æ€§æ— é™æ¥è¿‘äº 100%ã€‚</span></p></li><li><p><strong><span>æ–¹ä¾¿æ˜“ç”¨</span></strong><span>ï¼šæ‹¿æ¥å³ç”¨ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œå¿«é€Ÿæ¥å…¥ï¼</span></p></li></ul><p><span>é™¤äº†è¿™äº›ä¹‹å¤–ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„åˆ†å¸ƒå¼ ID è¿˜åº”ä¿è¯ï¼š</span></p><ul><li><p><strong><span>å®‰å…¨</span></strong><span>ï¼šID ä¸­ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ã€‚</span></p></li><li><p><strong><span>æœ‰åºé€’å¢</span></strong><span>ï¼šå¦‚æœè¦æŠŠ ID å­˜æ”¾åœ¨æ•°æ®åº“çš„è¯ï¼ŒID çš„æœ‰åºæ€§å¯ä»¥æå‡æ•°æ®åº“å†™å…¥é€Ÿåº¦ã€‚å¹¶ä¸”ï¼Œå¾ˆå¤šæ—¶å€™ ï¼Œæˆ‘ä»¬è¿˜å¾ˆæœ‰å¯èƒ½ä¼šç›´æ¥é€šè¿‡ ID æ¥è¿›è¡Œæ’åºã€‚</span></p></li><li><p><strong><span>æœ‰å…·ä½“çš„ä¸šåŠ¡å«ä¹‰</span></strong><span>ï¼šç”Ÿæˆçš„ ID å¦‚æœèƒ½æœ‰å…·ä½“çš„ä¸šåŠ¡å«ä¹‰ï¼Œå¯ä»¥è®©å®šä½é—®é¢˜ä»¥åŠå¼€å‘æ›´é€æ˜åŒ–ï¼ˆé€šè¿‡ ID å°±èƒ½ç¡®å®šæ˜¯å“ªä¸ªä¸šåŠ¡ï¼‰ã€‚</span></p></li><li><p><strong><span>ç‹¬ç«‹éƒ¨ç½²</span></strong><span>ï¼šä¹Ÿå°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå•ç‹¬æœ‰ä¸€ä¸ªå‘å·å™¨æœåŠ¡ï¼Œä¸“é—¨ç”¨æ¥ç”Ÿæˆåˆ†å¸ƒå¼ IDã€‚è¿™æ ·å°±ç”Ÿæˆ ID çš„æœåŠ¡å¯ä»¥å’Œä¸šåŠ¡ç›¸å…³çš„æœåŠ¡è§£è€¦ã€‚ä¸è¿‡ï¼Œè¿™æ ·åŒæ ·å¸¦æ¥äº†ç½‘ç»œè°ƒç”¨æ¶ˆè€—å¢åŠ çš„é—®é¢˜ã€‚æ€»çš„æ¥è¯´ï¼Œå¦‚æœéœ€è¦ç”¨åˆ°åˆ†å¸ƒå¼ ID çš„åœºæ™¯æ¯”è¾ƒå¤šçš„è¯ï¼Œç‹¬ç«‹éƒ¨ç½²çš„å‘å·å™¨æœåŠ¡è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</span></p></li></ul><h3 id='åˆ†å¸ƒå¼-id-å¸¸è§è§£å†³æ–¹æ¡ˆ'><span>åˆ†å¸ƒå¼ ID å¸¸è§è§£å†³æ–¹æ¡ˆ</span></h3><h4 id='æ•°æ®åº“'><span>æ•°æ®åº“</span></h4><ul><li><p><strong><span>ä¸»é”®è‡ªå¢ï¼š</span></strong><span>è¿™ç§æ–¹å¼å°±æ¯”è¾ƒç®€å•ç›´ç™½äº†ï¼Œå°±æ˜¯é€šè¿‡å…³ç³»å‹æ•°æ®åº“çš„è‡ªå¢ä¸»é”®äº§ç”Ÿæ¥å”¯ä¸€çš„ IDã€‚ä»¥ MySQL ä¸¾ä¾‹ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„æ–¹å¼å³å¯ã€‚</span></p><ul><li><p><strong><span>åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¡¨ã€‚</span></strong><code>stub</code><span> å­—æ®µæ— æ„ä¹‰ï¼Œåªæ˜¯ä¸ºäº†å ä½ï¼Œä¾¿äºæˆ‘ä»¬æ’å…¥æˆ–è€…ä¿®æ”¹æ•°æ®ã€‚å¹¶ä¸”ï¼Œç»™ </span><code>stub</code><span> å­—æ®µåˆ›å»ºäº†å”¯ä¸€ç´¢å¼•ï¼Œä¿è¯å…¶å”¯ä¸€æ€§ã€‚</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">CREATE</span> <span class="cm-keyword">TABLE</span> <span class="cm-variable-2">`sequence_id`</span> <span class="cm-bracket">(</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">`id`</span> <span class="cm-type">bigint</span><span class="cm-bracket">(</span><span class="cm-number">20</span><span class="cm-bracket">)</span> <span class="cm-type">unsigned</span> <span class="cm-keyword">NOT</span> <span class="cm-atom">NULL</span> <span class="cm-keyword">AUTO_INCREMENT</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">`stub`</span> <span class="cm-type">char</span><span class="cm-bracket">(</span><span class="cm-number">10</span><span class="cm-bracket">)</span> <span class="cm-keyword">NOT</span> <span class="cm-atom">NULL</span> <span class="cm-keyword">DEFAULT</span> <span class="cm-string">''</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">PRIMARY</span> <span class="cm-keyword">KEY</span> <span class="cm-bracket">(</span><span class="cm-variable-2">`id`</span><span class="cm-bracket">)</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">UNIQUE</span> <span class="cm-keyword">KEY</span> <span class="cm-variable-2">`stub`</span> <span class="cm-bracket">(</span><span class="cm-variable-2">`stub`</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">)</span> <span class="cm-keyword">ENGINE</span><span class="cm-operator">=</span><span class="cm-keyword">InnoDB</span> <span class="cm-keyword">DEFAULT</span> <span class="cm-builtin">CHARSET</span><span class="cm-operator">=</span>utf8mb4<span class="cm-punctuation">;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre></li><li><p><strong><span>é€šè¿‡ </span><code>replace into</code><span> æ¥æ’å…¥æ•°æ®ã€‚</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span><span class="cm-punctuation">;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">REPLACE</span> <span class="cm-keyword">INTO</span> sequence_id <span class="cm-bracket">(</span>stub<span class="cm-bracket">)</span> <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'stub'</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> LAST_INSERT_ID<span class="cm-bracket">()</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">COMMIT</span><span class="cm-punctuation">;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><ul><li><p><span>ç¬¬ä¸€æ­¥ï¼šå°è¯•æŠŠæ•°æ®æ’å…¥åˆ°è¡¨ä¸­ã€‚</span></p></li><li><p><span>ç¬¬äºŒæ­¥ï¼šå¦‚æœä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•å­—æ®µå‡ºç°é‡å¤æ•°æ®é”™è¯¯è€Œæ’å…¥å¤±è´¥æ—¶ï¼Œå…ˆä»è¡¨ä¸­åˆ é™¤å«æœ‰é‡å¤å…³é”®å­—å€¼çš„å†²çªè¡Œï¼Œç„¶åå†æ¬¡å°è¯•æŠŠæ•°æ®æ’å…¥åˆ°è¡¨ä¸­ã€‚</span></p></li></ul></li></ul></li><li><p><span>è¿™ç§æ–¹å¼çš„ä¼˜ç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼š</span></p></li><li><p><strong><span>ä¼˜ç‚¹</span></strong><span>ï¼šå®ç°èµ·æ¥æ¯”è¾ƒç®€å•ã€ID æœ‰åºé€’å¢ã€å­˜å‚¨æ¶ˆè€—ç©ºé—´å°</span></p></li><li><p><strong><span>ç¼ºç‚¹</span></strong><span>ï¼šæ”¯æŒçš„å¹¶å‘é‡ä¸å¤§ã€å­˜åœ¨æ•°æ®åº“å•ç‚¹é—®é¢˜ï¼ˆå¯ä»¥ä½¿ç”¨æ•°æ®åº“é›†ç¾¤è§£å†³ï¼Œä¸è¿‡å¢åŠ äº†å¤æ‚åº¦ï¼‰ã€ID æ²¡æœ‰å…·ä½“ä¸šåŠ¡å«ä¹‰ã€å®‰å…¨é—®é¢˜ï¼ˆæ¯”å¦‚æ ¹æ®è®¢å• ID çš„é€’å¢è§„å¾‹å°±èƒ½æ¨ç®—å‡ºæ¯å¤©çš„è®¢å•é‡ï¼Œå•†ä¸šæœºå¯†å•Šï¼ ï¼‰ã€æ¯æ¬¡è·å– ID éƒ½è¦è®¿é—®ä¸€æ¬¡æ•°æ®åº“ï¼ˆå¢åŠ äº†å¯¹æ•°æ®åº“çš„å‹åŠ›ï¼Œè·å–é€Ÿåº¦ä¹Ÿæ…¢ï¼‰</span></p></li></ul><h4 id='æ•°æ®åº“å·æ®µæ¨¡å¼'><span>æ•°æ®åº“å·æ®µæ¨¡å¼</span></h4><p><span>æ•°æ®åº“ä¸»é”®è‡ªå¢è¿™ç§æ¨¡å¼ï¼Œæ¯æ¬¡è·å– ID éƒ½è¦è®¿é—®ä¸€æ¬¡æ•°æ®åº“ï¼ŒID éœ€æ±‚æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œè‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚</span></p><p><span>å¦‚æœæˆ‘ä»¬å¯ä»¥æ‰¹é‡è·å–ï¼Œç„¶åå­˜åœ¨åœ¨å†…å­˜é‡Œé¢ï¼Œéœ€è¦ç”¨åˆ°çš„æ—¶å€™ï¼Œç›´æ¥ä»å†…å­˜é‡Œé¢æ‹¿å°±èˆ’æœäº†ï¼è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ </span><strong><span>åŸºäºæ•°æ®åº“çš„å·æ®µæ¨¡å¼æ¥ç”Ÿæˆåˆ†å¸ƒå¼ IDã€‚</span></strong></p><p><span>æ•°æ®åº“çš„å·æ®µæ¨¡å¼ä¹Ÿæ˜¯ç›®å‰æ¯”è¾ƒä¸»æµçš„ä¸€ç§åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹å¼ã€‚åƒæ»´æ»´å¼€æºçš„</span><a href='https://github.com/didi/tinyid/wiki/tinyidåŸç†ä»‹ç»'><span>Tinyidopen in new window</span></a><span> å°±æ˜¯åŸºäºè¿™ç§æ–¹å¼æ¥åšçš„ã€‚ä¸è¿‡ï¼ŒTinyId ä½¿ç”¨äº†åŒå·æ®µç¼“å­˜ã€å¢åŠ å¤š db æ”¯æŒç­‰æ–¹å¼æ¥è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚</span></p><p><span>ä»¥ MySQL ä¸¾ä¾‹ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„æ–¹å¼å³å¯ã€‚</span></p><p><strong><span>1. åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¡¨ã€‚</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">CREATE</span> <span class="cm-keyword">TABLE</span> <span class="cm-variable-2">`sequence_id_generator`</span> <span class="cm-bracket">(</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">`id`</span> <span class="cm-type">int</span><span class="cm-bracket">(</span><span class="cm-number">10</span><span class="cm-bracket">)</span> <span class="cm-keyword">NOT</span> <span class="cm-atom">NULL</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">`current_max_id`</span> <span class="cm-type">bigint</span><span class="cm-bracket">(</span><span class="cm-number">20</span><span class="cm-bracket">)</span> <span class="cm-keyword">NOT</span> <span class="cm-atom">NULL</span> <span class="cm-keyword">COMMENT</span> <span class="cm-string">'å½“å‰æœ€å¤§id'</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">`step`</span> <span class="cm-type">int</span><span class="cm-bracket">(</span><span class="cm-number">10</span><span class="cm-bracket">)</span> <span class="cm-keyword">NOT</span> <span class="cm-atom">NULL</span> <span class="cm-keyword">COMMENT</span> <span class="cm-string">'å·æ®µçš„é•¿åº¦'</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">`version`</span> <span class="cm-type">int</span><span class="cm-bracket">(</span><span class="cm-number">20</span><span class="cm-bracket">)</span> <span class="cm-keyword">NOT</span> <span class="cm-atom">NULL</span> <span class="cm-keyword">COMMENT</span> <span class="cm-string">'ç‰ˆæœ¬å·'</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">`biz_type`</span> &nbsp; &nbsp;<span class="cm-type">int</span><span class="cm-bracket">(</span><span class="cm-number">20</span><span class="cm-bracket">)</span> <span class="cm-keyword">NOT</span> <span class="cm-atom">NULL</span> <span class="cm-keyword">COMMENT</span> <span class="cm-string">'ä¸šåŠ¡ç±»å‹'</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-keyword">PRIMARY</span> <span class="cm-keyword">KEY</span> <span class="cm-bracket">(</span><span class="cm-variable-2">`id`</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">)</span> <span class="cm-keyword">ENGINE</span><span class="cm-operator">=</span><span class="cm-keyword">InnoDB</span> <span class="cm-keyword">DEFAULT</span> <span class="cm-builtin">CHARSET</span><span class="cm-operator">=</span>utf8mb4<span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 207px;"></div><div class="CodeMirror-gutters" style="display: none; height: 207px;"></div></div></div></pre><p><code>current_max_id</code><span> å­—æ®µå’Œ</span><code>step</code><span>å­—æ®µä¸»è¦ç”¨äºè·å–æ‰¹é‡ IDï¼Œè·å–çš„æ‰¹é‡ id ä¸ºï¼š</span><code>current_max_id ~ current_max_id+step</code><span>ã€‚</span><code>version</code><span> å­—æ®µä¸»è¦ç”¨äºè§£å†³å¹¶å‘é—®é¢˜ï¼ˆä¹è§‚é”ï¼‰,</span><code>biz_type</code><span> ä¸»è¦ç”¨äºè¡¨ç¤ºä¸šåŠ¡ç±»å‹ã€‚</span></p><p><strong><span>2. å…ˆæ’å…¥ä¸€è¡Œæ•°æ®ã€‚</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-variable-2">`sequence_id_generator`</span> <span class="cm-bracket">(</span><span class="cm-variable-2">`id`</span><span class="cm-punctuation">,</span> <span class="cm-variable-2">`current_max_id`</span><span class="cm-punctuation">,</span> <span class="cm-variable-2">`step`</span><span class="cm-punctuation">,</span> <span class="cm-variable-2">`version`</span><span class="cm-punctuation">,</span> <span class="cm-variable-2">`biz_type`</span><span class="cm-bracket">)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">VALUES</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-bracket">(</span><span class="cm-number">1</span><span class="cm-punctuation">,</span> <span class="cm-number">0</span><span class="cm-punctuation">,</span> <span class="cm-number">100</span><span class="cm-punctuation">,</span> <span class="cm-number">0</span><span class="cm-punctuation">,</span> <span class="cm-number">101</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><strong><span>3. é€šè¿‡ SELECT è·å–æŒ‡å®šä¸šåŠ¡ä¸‹çš„æ‰¹é‡å”¯ä¸€ ID</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> <span class="cm-variable-2">`current_max_id`</span><span class="cm-punctuation">,</span> <span class="cm-variable-2">`step`</span><span class="cm-punctuation">,</span><span class="cm-variable-2">`version`</span> <span class="cm-keyword">FROM</span> <span class="cm-variable-2">`sequence_id_generator`</span> <span class="cm-keyword">where</span> <span class="cm-variable-2">`biz_type`</span> <span class="cm-operator">=</span> <span class="cm-number">101</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>ç»“æœï¼š</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">id current_max_id step version biz_type</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">1</span> <span class="cm-number">0</span> <span class="cm-number">100</span> <span class="cm-number">0</span> <span class="cm-number">101</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p><strong><span>4. ä¸å¤Ÿç”¨çš„è¯ï¼Œæ›´æ–°ä¹‹åé‡æ–° SELECT å³å¯ã€‚</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">UPDATE</span> sequence_id_generator <span class="cm-keyword">SET</span> current_max_id <span class="cm-operator">=</span> <span class="cm-number">0</span><span class="cm-operator">+</span><span class="cm-number">100</span><span class="cm-punctuation">,</span> version<span class="cm-operator">=</span>version<span class="cm-operator">+</span><span class="cm-number">1</span> <span class="cm-keyword">WHERE</span> version <span class="cm-operator">=</span> <span class="cm-number">0</span> &nbsp;<span class="cm-keyword">AND</span> <span class="cm-variable-2">`biz_type`</span> <span class="cm-operator">=</span> <span class="cm-number">101</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> <span class="cm-variable-2">`current_max_id`</span><span class="cm-punctuation">,</span> <span class="cm-variable-2">`step`</span><span class="cm-punctuation">,</span><span class="cm-variable-2">`version`</span> <span class="cm-keyword">FROM</span> <span class="cm-variable-2">`sequence_id_generator`</span> <span class="cm-keyword">where</span> <span class="cm-variable-2">`biz_type`</span> <span class="cm-operator">=</span> <span class="cm-number">101</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p>&nbsp;</p><p><span>ç›¸æ¯”äºæ•°æ®åº“ä¸»é”®è‡ªå¢çš„æ–¹å¼ï¼Œ</span><strong><span>æ•°æ®åº“çš„å·æ®µæ¨¡å¼å¯¹äºæ•°æ®åº“çš„è®¿é—®æ¬¡æ•°æ›´å°‘ï¼Œæ•°æ®åº“å‹åŠ›æ›´å°ã€‚</span></strong></p><p><span>å¦å¤–ï¼Œä¸ºäº†é¿å…å•ç‚¹é—®é¢˜ï¼Œä½ å¯ä»¥ä»ä½¿ç”¨ä¸»ä»æ¨¡å¼æ¥æé«˜å¯ç”¨æ€§ã€‚</span></p><p><strong><span>æ•°æ®åº“å·æ®µæ¨¡å¼çš„ä¼˜ç¼ºç‚¹:</span></strong></p><ul><li><p><strong><span>ä¼˜ç‚¹</span></strong><span>ï¼šID æœ‰åºé€’å¢ã€å­˜å‚¨æ¶ˆè€—ç©ºé—´å°</span></p></li><li><p><strong><span>ç¼ºç‚¹</span></strong><span>ï¼šå­˜åœ¨æ•°æ®åº“å•ç‚¹é—®é¢˜ï¼ˆå¯ä»¥ä½¿ç”¨æ•°æ®åº“é›†ç¾¤è§£å†³ï¼Œä¸è¿‡å¢åŠ äº†å¤æ‚åº¦ï¼‰ã€ID æ²¡æœ‰å…·ä½“ä¸šåŠ¡å«ä¹‰ã€å®‰å…¨é—®é¢˜ï¼ˆæ¯”å¦‚æ ¹æ®è®¢å• ID çš„é€’å¢è§„å¾‹å°±èƒ½æ¨ç®—å‡ºæ¯å¤©çš„è®¢å•é‡ï¼Œå•†ä¸šæœºå¯†å•Šï¼ ï¼‰</span></p></li></ul><h4 id='nosql'><span>NoSQL</span></h4><p><span>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒNoSQL æ–¹æ¡ˆä½¿ç”¨ Redis å¤šä¸€äº›ã€‚æˆ‘ä»¬é€šè¿‡ Redis çš„ </span><code>incr</code><span> å‘½ä»¤å³å¯å®ç°å¯¹ id åŸå­é¡ºåºé€’å¢ã€‚</span></p><p><span>ä¸ºäº†æé«˜å¯ç”¨æ€§å’Œå¹¶å‘ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Redis Clusterã€‚Redis Cluster æ˜¯ Redis å®˜æ–¹æä¾›çš„ Redis é›†ç¾¤è§£å†³æ–¹æ¡ˆï¼ˆ3.0+ç‰ˆæœ¬ï¼‰ã€‚</span></p><p><span>é™¤äº† Redis Cluster ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å¼€æºçš„ Redis é›†ç¾¤æ–¹æ¡ˆ</span><a href='https://github.com/CodisLabs/codis'><span>Codisopen in new window</span></a><span> ï¼ˆå¤§è§„æ¨¡é›†ç¾¤æ¯”å¦‚ä¸Šç™¾ä¸ªèŠ‚ç‚¹çš„æ—¶å€™æ¯”è¾ƒæ¨èï¼‰ã€‚</span></p><p><strong><span>Redis æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹ï¼š</span></strong></p><ul><li><p><strong><span>ä¼˜ç‚¹</span></strong><span>ï¼šæ€§èƒ½ä¸é”™å¹¶ä¸”ç”Ÿæˆçš„ ID æ˜¯æœ‰åºé€’å¢çš„</span></p></li><li><p><strong><span>ç¼ºç‚¹</span></strong><span>ï¼šå’Œæ•°æ®åº“ä¸»é”®è‡ªå¢æ–¹æ¡ˆçš„ç¼ºç‚¹ç±»ä¼¼</span></p></li></ul><h4 id='ç®—æ³•'><span>ç®—æ³•</span></h4><ul><li><p><span>UUID</span></p><ul><li><p><span>UUID æ˜¯ Universally Unique Identifierï¼ˆé€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰ çš„ç¼©å†™ã€‚UUID åŒ…å« 32 ä¸ª 16 è¿›åˆ¶æ•°å­—ï¼ˆ8-4-4-4-12ï¼‰ã€‚</span></p></li><li><p><span>JDK å°±æä¾›äº†ç°æˆçš„ç”Ÿæˆ UUID çš„æ–¹æ³•ï¼Œä¸€è¡Œä»£ç å°±è¡Œäº†ã€‚</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//è¾“å‡ºç¤ºä¾‹ï¼šcb4a9ede-fa5e-4585-b9bb-d60bce986eaa</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UUID</span>.<span class="cm-variable">randomUUID</span>()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><ul><li><p><span>5 ç§ä¸åŒçš„ Version(ç‰ˆæœ¬)å€¼åˆ†åˆ«å¯¹åº”çš„å«ä¹‰ï¼ˆå‚è€ƒ</span><a href='https://zh.wikipedia.org/wiki/é€šç”¨å”¯ä¸€è¯†åˆ«ç '><span>ç»´åŸºç™¾ç§‘å¯¹äº UUID çš„ä»‹ç»open in new window</span></a><span>ï¼‰ï¼š</span></p><ul><li><p><strong><span>ç‰ˆæœ¬ 1</span></strong><span> : UUID æ˜¯æ ¹æ®æ—¶é—´å’ŒèŠ‚ç‚¹ IDï¼ˆé€šå¸¸æ˜¯ MAC åœ°å€ï¼‰ç”Ÿæˆï¼›</span></p></li></ul></li><li><p><strong><span>ç‰ˆæœ¬ 2</span></strong><span> : UUID æ˜¯æ ¹æ®æ ‡è¯†ç¬¦ï¼ˆé€šå¸¸æ˜¯ç»„æˆ–ç”¨æˆ· IDï¼‰ã€æ—¶é—´å’ŒèŠ‚ç‚¹ ID ç”Ÿæˆï¼›</span></p></li><li><p><strong><span>ç‰ˆæœ¬ 3ã€ç‰ˆæœ¬ 5</span></strong><span> : ç‰ˆæœ¬ 5 - ç¡®å®šæ€§ UUID é€šè¿‡æ•£åˆ—ï¼ˆhashingï¼‰åå­—ç©ºé—´ï¼ˆnamespaceï¼‰æ ‡è¯†ç¬¦å’Œåç§°ç”Ÿæˆï¼›</span></p></li><li><p><strong><span>ç‰ˆæœ¬ 4</span></strong><span> : UUID ä½¿ç”¨</span><a href='https://zh.wikipedia.org/wiki/éšæœºæ€§'><span>éšæœºæ€§open in new window</span></a><span>æˆ–</span><a href='https://zh.wikipedia.org/wiki/ä¼ªéšæœºæ€§'><span>ä¼ªéšæœºæ€§open in new window</span></a><span>ç”Ÿæˆã€‚</span></p></li><li><p><strong><span>ä¼˜ç‚¹</span></strong><span>ï¼šç”Ÿæˆé€Ÿåº¦æ¯”è¾ƒå¿«ã€ç®€å•æ˜“ç”¨</span></p></li><li><p><strong><span>ç¼ºç‚¹</span></strong><span>ï¼šå­˜å‚¨æ¶ˆè€—ç©ºé—´å¤§ï¼ˆ32 ä¸ªå­—ç¬¦ä¸²ï¼Œ128 ä½ï¼‰ã€ ä¸å®‰å…¨ï¼ˆåŸºäº MAC åœ°å€ç”Ÿæˆ UUID çš„ç®—æ³•ä¼šé€ æˆ MAC åœ°å€æ³„éœ²)ã€æ— åºï¼ˆéè‡ªå¢ï¼‰ã€æ²¡æœ‰å…·ä½“ä¸šåŠ¡å«ä¹‰ã€éœ€è¦è§£å†³é‡å¤ ID é—®é¢˜ï¼ˆå½“æœºå™¨æ—¶é—´ä¸å¯¹çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¯¼è‡´ä¼šäº§ç”Ÿé‡å¤ IDï¼‰</span></p></li></ul></li><li><p><strong><span>Snowflake(é›ªèŠ±ç®—æ³•)</span></strong></p><ul><li><p><span>snowflake æ˜¯ Twitter å¼€æºçš„åˆ†å¸ƒå¼ ID ç”Ÿæˆç®—æ³•ã€‚Snowflake ç”± 64 bit çš„äºŒè¿›åˆ¶æ•°å­—ç»„æˆï¼Œè¿™ 64bit çš„äºŒè¿›åˆ¶è¢«åˆ†æˆäº†å‡ éƒ¨åˆ†ï¼Œæ¯ä¸€éƒ¨åˆ†å­˜å‚¨çš„æ•°æ®éƒ½æœ‰ç‰¹å®šçš„å«ä¹‰ï¼š</span></p><ul><li><p><strong><span>sign(1bit)</span></strong><span>:ç¬¦å·ä½ï¼ˆæ ‡è¯†æ­£è´Ÿï¼‰ï¼Œå§‹ç»ˆä¸º 0ï¼Œä»£è¡¨ç”Ÿæˆçš„ ID ä¸ºæ­£æ•°ã€‚</span></p></li><li><p><strong><span>timestamp (41 bits)</span></strong><span>:ä¸€å…± 41 ä½ï¼Œç”¨æ¥è¡¨ç¤ºæ—¶é—´æˆ³ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œå¯ä»¥æ”¯æ’‘ 2 ^41 æ¯«ç§’ï¼ˆçº¦ 69 å¹´ï¼‰</span></p></li><li><p><strong><span>datacenter id + worker id (10 bits)</span></strong><span>:ä¸€èˆ¬æ¥è¯´ï¼Œå‰ 5 ä½è¡¨ç¤ºæœºæˆ¿ IDï¼Œå 5 ä½è¡¨ç¤ºæœºå™¨ IDï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰ã€‚è¿™æ ·å°±å¯ä»¥åŒºåˆ†ä¸åŒé›†ç¾¤/æœºæˆ¿çš„èŠ‚ç‚¹ã€‚</span></p></li><li><p><strong><span>sequence (12 bits)</span></strong><span>:ä¸€å…± 12 ä½ï¼Œç”¨æ¥è¡¨ç¤ºåºåˆ—å·ã€‚ åºåˆ—å·ä¸ºè‡ªå¢å€¼ï¼Œä»£è¡¨å•å°æœºå™¨æ¯æ¯«ç§’èƒ½å¤Ÿäº§ç”Ÿçš„æœ€å¤§ ID æ•°(2^12 = 4096),ä¹Ÿå°±æ˜¯è¯´å•å°æœºå™¨æ¯æ¯«ç§’æœ€å¤šå¯ä»¥ç”Ÿæˆ 4096 ä¸ª å”¯ä¸€ IDã€‚</span></p></li></ul></li><li><p><strong><span>ä¼˜ç‚¹</span></strong><span>ï¼šç”Ÿæˆé€Ÿåº¦æ¯”è¾ƒå¿«ã€ç”Ÿæˆçš„ ID æœ‰åºé€’å¢ã€æ¯”è¾ƒçµæ´»ï¼ˆå¯ä»¥å¯¹ Snowflake ç®—æ³•è¿›è¡Œç®€å•çš„æ”¹é€ æ¯”å¦‚åŠ å…¥ä¸šåŠ¡ IDï¼‰</span></p></li><li><p><strong><span>ç¼ºç‚¹</span></strong><span>ï¼šéœ€è¦è§£å†³é‡å¤ ID é—®é¢˜ï¼ˆID ç”Ÿæˆä¾èµ–æ—¶é—´ï¼Œåœ¨è·å–æ—¶é—´çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°æ—¶é—´å›æ‹¨çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨ä¸Šçš„æ—¶é—´çªç„¶å€’é€€åˆ°ä¹‹å‰çš„æ—¶é—´ï¼Œè¿›è€Œå¯¼è‡´ä¼šäº§ç”Ÿé‡å¤ IDï¼‰ã€ä¾èµ–æœºå™¨ ID å¯¹åˆ†å¸ƒå¼ç¯å¢ƒä¸å‹å¥½ï¼ˆå½“éœ€è¦è‡ªåŠ¨å¯åœæˆ–å¢å‡æœºå™¨æ—¶ï¼Œå›ºå®šçš„æœºå™¨ ID å¯èƒ½ä¸å¤Ÿçµæ´»ï¼‰ã€‚</span></p></li></ul><blockquote><p><span>æ—¶é’Ÿå›æ‹¨é—®é¢˜è§£å†³</span></p><p><span>æœåŠ¡å¯åŠ¨æ—¶é¦–å…ˆæ£€æŸ¥è‡ªå·±æ˜¯å¦å†™è¿‡ZooKeeper leaf_foreverèŠ‚ç‚¹ï¼š</span></p><ol start='' ><li><p><span>è‹¥å†™è¿‡ï¼Œåˆ™ç”¨è‡ªèº«ç³»ç»Ÿæ—¶é—´ä¸leaf_forever/${self}èŠ‚ç‚¹è®°å½•æ—¶é—´åšæ¯”è¾ƒï¼Œè‹¥å°äºleaf_forever/${self}æ—¶é—´åˆ™è®¤ä¸ºæœºå™¨æ—¶é—´å‘ç”Ÿäº†å¤§æ­¥é•¿å›æ‹¨ï¼ŒæœåŠ¡å¯åŠ¨å¤±è´¥å¹¶æŠ¥è­¦ã€‚</span></p></li><li><p><span>è‹¥æœªå†™è¿‡ï¼Œè¯æ˜æ˜¯æ–°æœåŠ¡èŠ‚ç‚¹ï¼Œç›´æ¥åˆ›å»ºæŒä¹…èŠ‚ç‚¹leaf_forever/${self}å¹¶å†™å…¥è‡ªèº«ç³»ç»Ÿæ—¶é—´ï¼Œæ¥ä¸‹æ¥ç»¼åˆå¯¹æ¯”å…¶ä½™LeafèŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´æ¥åˆ¤æ–­è‡ªèº«ç³»ç»Ÿæ—¶é—´æ˜¯å¦å‡†ç¡®ï¼Œå…·ä½“åšæ³•æ˜¯å–leaf_temporaryä¸‹çš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹(æ‰€æœ‰è¿è¡Œä¸­çš„Leaf-snowflakeèŠ‚ç‚¹)çš„æœåŠ¡IPï¼šPortï¼Œç„¶åé€šè¿‡RPCè¯·æ±‚å¾—åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´ï¼Œè®¡ç®—sum(time)/nodeSizeã€‚</span></p></li><li><p><span>è‹¥abs( ç³»ç»Ÿæ—¶é—´-sum(time)/nodeSize ) &lt; é˜ˆå€¼ï¼Œè®¤ä¸ºå½“å‰ç³»ç»Ÿæ—¶é—´å‡†ç¡®ï¼Œæ­£å¸¸å¯åŠ¨æœåŠ¡ï¼ŒåŒæ—¶å†™ä¸´æ—¶èŠ‚ç‚¹leaf_temporary/${self} ç»´æŒç§Ÿçº¦ã€‚</span></p></li><li><p><span>å¦åˆ™è®¤ä¸ºæœ¬æœºç³»ç»Ÿæ—¶é—´å‘ç”Ÿå¤§æ­¥é•¿åç§»ï¼Œå¯åŠ¨å¤±è´¥å¹¶æŠ¥è­¦ã€‚</span></p></li><li><p><span>æ¯éš”ä¸€æ®µæ—¶é—´(3s)ä¸ŠæŠ¥è‡ªèº«ç³»ç»Ÿæ—¶é—´å†™å…¥leaf_forever/${self}ã€‚</span></p></li></ol></blockquote></li></ul><h4 id='å¼€æºæ¡†æ¶'><span>å¼€æºæ¡†æ¶</span></h4><ul><li><p><span>UidGenerator(ç™¾åº¦)</span></p></li><li><p><span>Leaf(ç¾å›¢)</span></p></li><li><p><span>Tinyid(æ»´æ»´)</span></p></li></ul><h1 id='å››æœåŠ¡å‘ç°æ³¨å†Œ'><span>å››ã€æœåŠ¡å‘ç°/æ³¨å†Œ</span></h1><h2 id='1-zookeeper'><span>1. Zookeeper</span></h2><p><a href='https://blog.csdn.net/qq_37555071/article/details/114609145' target='_blank' class='url'>https://blog.csdn.net/qq_37555071/article/details/114609145</a></p><h3 id='æ¦‚è¿°'><span>æ¦‚è¿°</span></h3><ul><li><p><span>ç®€å•æ¥è¯´ï¼Œ </span><code>ZooKeeper</code><span> æ˜¯ä¸€ä¸ª </span><strong><span>åˆ†å¸ƒå¼åè°ƒæœåŠ¡æ¡†æ¶</span></strong><span> ã€‚å¯¹äºåˆ†å¸ƒå¼æ¥è¯´ï¼Œé¦–å…ˆéœ€è¦å°†ä¸šåŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œç„¶åå†åŠ æœºå™¨ï¼ŒåŒæ—¶ä½ è¿˜è¦å»è§£å†³åˆ†å¸ƒå¼å¸¦æ¥çš„ä¸€ç³»åˆ—é—®é¢˜ã€‚</span></p></li><li><p><strong><span>ä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯</span></strong><span>ï¼šå„ä¸ªåˆ†å¸ƒå¼ç»„ä»¶å¦‚ä½•åè°ƒèµ·æ¥ï¼Œå¦‚ä½•å‡å°‘å„ä¸ªç³»ç»Ÿä¹‹é—´çš„è€¦åˆåº¦ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡çš„å¤„ç†ï¼Œå¦‚ä½•å»é…ç½®æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿç­‰ç­‰ã€‚</span></p></li><li><p><span>è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¿…å®šä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜â€”â€” </span><strong><span>å› ä¸ºåˆ†åŒºå®¹å¿æ€§ï¼ˆpartition toleranceï¼‰çš„å­˜åœ¨ï¼Œå°±å¿…å®šè¦æ±‚æˆ‘ä»¬éœ€è¦åœ¨ç³»ç»Ÿå¯ç”¨æ€§ï¼ˆavailabilityï¼‰å’Œæ•°æ®ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰ä¸­åšå‡ºæƒè¡¡</span></strong><span> ã€‚è¿™å°±æ˜¯è‘—åçš„ </span><code>CAP</code><span> å®šç†ã€‚</span><code>ZooKeeper</code><span> çš„å¤„ç†æ–¹å¼ï¼Œå®ƒä¿è¯äº† CPï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰ã€‚</span></p></li></ul><h3 id='ä¸€è‡´æ€§åè®®å’Œç®—æ³•'><span>ä¸€è‡´æ€§åè®®å’Œç®—æ³•</span></h3><p><a href='https://mp.weixin.qq.com/s/b5mGEbn-FLb9vhOh1OpwIg' target='_blank' class='url'>https://mp.weixin.qq.com/s/b5mGEbn-FLb9vhOh1OpwIg</a></p><p><span>è€Œä¸ºäº†è§£å†³æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œåœ¨ç§‘å­¦å®¶å’Œç¨‹åºå‘˜çš„ä¸æ–­æ¢ç´¢ä¸­ï¼Œå°±å‡ºç°äº†å¾ˆå¤šçš„ä¸€è‡´æ€§åè®®å’Œç®—æ³•ã€‚æ¯”å¦‚ 2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ï¼Œ3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰ï¼ŒPaxos ç®—æ³•ç­‰ç­‰ã€‚</span></p><ul><li><p><span>2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰</span></p><ul><li><p><span>ä¸¤é˜¶æ®µæäº¤æ˜¯ä¸€ç§ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§çš„åè®®ï¼Œç°åœ¨å¾ˆå¤šæ•°æ®åº“éƒ½æ˜¯é‡‡ç”¨çš„ä¸¤é˜¶æ®µæäº¤åè®®æ¥å®Œæˆ </span><strong><span>åˆ†å¸ƒå¼äº‹åŠ¡</span></strong><span> çš„å¤„ç†ã€‚</span></p></li><li><p><span>åœ¨ä¸¤é˜¶æ®µæäº¤ä¸­ï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯åè°ƒè€…å’Œå‚ä¸è€…ã€‚</span></p><ul><li><p><span>ç¬¬ä¸€é˜¶æ®µï¼šå½“è¦æ‰§è¡Œä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„æ—¶å€™ï¼Œäº‹åŠ¡å‘èµ·è€…é¦–å…ˆå‘åè°ƒè€…å‘èµ·äº‹åŠ¡è¯·æ±‚ï¼Œç„¶ååè°ƒè€…ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ </span><code>prepare</code><span> è¯·æ±‚ï¼ˆå…¶ä¸­åŒ…æ‹¬äº‹åŠ¡å†…å®¹ï¼‰å‘Šè¯‰å‚ä¸è€…ä½ ä»¬éœ€è¦æ‰§è¡Œäº‹åŠ¡äº†ï¼Œå¦‚æœèƒ½æ‰§è¡Œæˆ‘å‘çš„äº‹åŠ¡å†…å®¹é‚£ä¹ˆå°±å…ˆæ‰§è¡Œä½†ä¸æäº¤ï¼Œæ‰§è¡Œåè¯·ç»™æˆ‘å›å¤ã€‚ç„¶åå‚ä¸è€…æ”¶åˆ° </span><code>prepare</code><span> æ¶ˆæ¯åï¼Œä»–ä»¬ä¼šå¼€å§‹æ‰§è¡Œäº‹åŠ¡ï¼ˆä½†ä¸æäº¤ï¼‰ï¼Œå¹¶å°† </span><code>Undo</code><span> å’Œ </span><code>Redo</code><span> ä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ä¸­ï¼Œä¹‹åå‚ä¸è€…å°±å‘åè°ƒè€…åé¦ˆæ˜¯å¦å‡†å¤‡å¥½äº†ã€‚</span></p></li><li><p><span>ç¬¬äºŒé˜¶æ®µï¼šç¬¬äºŒé˜¶æ®µä¸»è¦æ˜¯åè°ƒè€…æ ¹æ®å‚ä¸è€…åé¦ˆçš„æƒ…å†µæ¥å†³å®šæ¥ä¸‹æ¥æ˜¯å¦å¯ä»¥è¿›è¡Œäº‹åŠ¡çš„æäº¤æ“ä½œï¼Œå³æäº¤äº‹åŠ¡æˆ–è€…å›æ»šäº‹åŠ¡ã€‚æ¯”å¦‚è¿™ä¸ªæ—¶å€™ </span><strong><span>æ‰€æœ‰çš„å‚ä¸è€…</span></strong><span> éƒ½è¿”å›äº†å‡†å¤‡å¥½äº†çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™å°±è¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œåè°ƒè€…æ­¤æ—¶ä¼šç»™æ‰€æœ‰çš„å‚ä¸è€…å‘é€ </span><strong><code>Commit</code><span> è¯·æ±‚</span></strong><span> ï¼Œå½“å‚ä¸è€…æ”¶åˆ° </span><code>Commit</code><span> è¯·æ±‚çš„æ—¶å€™ä¼šæ‰§è¡Œå‰é¢æ‰§è¡Œçš„äº‹åŠ¡çš„ </span><strong><span>æäº¤æ“ä½œ</span></strong><span> ï¼Œæäº¤å®Œæ¯•ä¹‹åå°†ç»™åè°ƒè€…å‘é€æäº¤æˆåŠŸçš„å“åº”ã€‚</span></p></li></ul><p><span>è€Œå¦‚æœåœ¨ç¬¬ä¸€é˜¶æ®µå¹¶ä¸æ˜¯æ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›äº†å‡†å¤‡å¥½äº†çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ­¤æ—¶åè°ƒè€…å°†ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ </span><strong><span>å›æ»šäº‹åŠ¡çš„ </span><code>rollback</code><span> è¯·æ±‚</span></strong><span>ï¼Œå‚ä¸è€…æ”¶åˆ°ä¹‹åå°†ä¼š </span><strong><span>å›æ»šå®ƒåœ¨ç¬¬ä¸€é˜¶æ®µæ‰€åšçš„äº‹åŠ¡å¤„ç†</span></strong><span> ï¼Œç„¶åå†å°†å¤„ç†æƒ…å†µè¿”å›ç»™åè°ƒè€…ï¼Œæœ€ç»ˆåè°ƒè€…æ”¶åˆ°å“åº”åä¾¿ç»™äº‹åŠ¡å‘èµ·è€…è¿”å›å¤„ç†å¤±è´¥çš„ç»“æœã€‚</span></p></li><li><p><span>ä¼˜ç‚¹ï¼šåŸç†ç®€å•ï¼Œå®ç°æ–¹ä¾¿</span></p></li><li><p><span>ç¼ºç‚¹:</span></p><ul><li><p><code>åŒæ­¥é˜»å¡</code><span>: åœ¨äºŒé˜¶æ®µæäº¤çš„è¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½åœ¨ç­‰å¾…å…¶ä»–èŠ‚ç‚¹çš„å“åº”ï¼Œæ— æ³•è¿›è¡Œå…¶ä»–æ“ä½œã€‚è¿™ç§åŒæ­¥é˜»å¡æå¤§çš„é™åˆ¶äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ€§èƒ½ã€‚</span></p></li><li><p><code>å•ç‚¹é—®é¢˜</code><span>:  åè°ƒè€…åœ¨æ•´ä¸ªäºŒé˜¶æ®µæäº¤è¿‡ç¨‹ä¸­å¾ˆé‡è¦ï¼Œå¦‚æœåè°ƒè€…åœ¨æäº¤é˜¶æ®µå‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆæ•´ä¸ªæµç¨‹å°†æ— æ³•è¿è½¬ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå…¶ä»–å‚ä¸è€…å°†ä¼šå¤„äºä¸€ç›´é”å®šäº‹åŠ¡èµ„æºçš„çŠ¶æ€ä¸­ï¼Œè€Œæ— æ³•ç»§ç»­å®Œæˆäº‹åŠ¡æ“ä½œ</span></p></li><li><p><code>æ•°æ®ä¸ä¸€è‡´</code><span>:  å‡è®¾å½“åè°ƒè€…å‘æ‰€æœ‰çš„å‚ä¸è€…å‘é€commitè¯·æ±‚ä¹‹åï¼Œå‘ç”Ÿäº†å±€éƒ¨ç½‘ç»œå¼‚å¸¸ï¼Œæˆ–è€…æ˜¯åè°ƒè€…åœ¨å°šæœªå‘é€å®Œæ‰€æœ‰ commitè¯·æ±‚ä¹‹å‰è‡ªèº«å‘ç”Ÿäº†å´©æºƒï¼Œå¯¼è‡´æœ€ç»ˆåªæœ‰éƒ¨åˆ†å‚ä¸è€…æ”¶åˆ°äº†commitè¯·æ±‚ã€‚è¿™å°†å¯¼è‡´ä¸¥é‡çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</span></p></li><li><p><code>å®¹é”™æ€§ä¸å¥½</code><span>:äºŒé˜¶æ®µæäº¤åè®®æ²¡æœ‰è®¾è®¡è¾ƒä¸ºå®Œå–„çš„å®¹é”™æœºåˆ¶ï¼Œä»»æ„ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªäº‹åŠ¡çš„å¤±è´¥ã€‚</span></p></li></ul></li></ul></li><li><p><span>3PC (ä¸‰é˜¶æ®µæäº¤)</span></p><ul><li><p><code>å¼•å…¥è¶…æ—¶æœºåˆ¶</code><span>ã€‚åŒæ—¶åœ¨åè°ƒè€…å’Œå‚ä¸è€…ä¸­éƒ½å¼•å…¥è¶…æ—¶æœºåˆ¶ã€‚</span></p></li><li><p><span>ç¬¬ä¸€é˜¶æ®µå’Œç¬¬äºŒé˜¶æ®µä¸­æ’å…¥ä¸€ä¸ª</span><code>å‡†å¤‡é˜¶æ®µ</code><span>ã€‚ä¿è¯äº†åœ¨æœ€åæäº¤é˜¶æ®µä¹‹å‰å„å‚ä¸èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤äº†å¼•å…¥è¶…æ—¶æœºåˆ¶ä¹‹å¤–ï¼Œ3PCæŠŠ2PCçš„</span><code>å‡†å¤‡é˜¶æ®µå†æ¬¡ä¸€åˆ†ä¸ºäºŒ</code><span>ï¼Œè¿™æ ·ä¸‰é˜¶æ®µæäº¤å°±æœ‰CanCommitã€PreCommitã€DoCommitä¸‰ä¸ªé˜¶æ®µã€‚</span></p><ul><li><p><strong><span>CanCommit é˜¶æ®µ</span></strong><span>ï¼šåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ </span><code>CanCommit</code><span> è¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°è¯·æ±‚åä¼šæ ¹æ®è‡ªèº«æƒ…å†µæŸ¥çœ‹æ˜¯å¦èƒ½æ‰§è¡Œäº‹åŠ¡ï¼Œå¦‚æœå¯ä»¥åˆ™è¿”å› YES å“åº”å¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ï¼Œå¦åˆ™è¿”å› NO ã€‚</span></p></li><li><p><strong><span>PreCommit é˜¶æ®µ</span></strong><span>ï¼šåè°ƒè€…æ ¹æ®å‚ä¸è€…çš„ååº”æƒ…å†µæ¥å†³å®šæ˜¯å¦å¯ä»¥è®°æ€§äº‹åŠ¡çš„PreCommitæ“ä½œã€‚æ ¹æ®å“åº”æƒ…å†µï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å¯èƒ½ã€‚å‡å¦‚åè°ƒè€…ä»æ‰€æœ‰çš„å‚ä¸è€…è·å¾—çš„åé¦ˆ</span><code>éƒ½æ˜¯Yeså“åº”</code><span>ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œäº‹åŠ¡çš„é¢„æ‰§è¡Œã€‚å‡å¦‚æœ‰ä»»ä½•ä¸€ä¸ªå‚ä¸è€…å‘åè°ƒè€…å‘é€äº†Noå“åº”</span><strong><span>ï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ä¹‹åï¼Œåè°ƒè€…éƒ½æ²¡æœ‰æ¥åˆ°å‚ä¸è€…çš„å“åº”ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œäº‹åŠ¡çš„</span><code>ä¸­æ–­</code><span>ã€‚</span></strong></p></li><li><p><strong><span>DoCommit é˜¶æ®µ</span></strong><span>ï¼šè¿™ä¸ªé˜¶æ®µå…¶å®å’Œ </span><code>2PC</code><span> çš„ç¬¬äºŒé˜¶æ®µå·®ä¸å¤šï¼Œå¦‚æœåè°ƒè€…æ”¶åˆ°äº†æ‰€æœ‰å‚ä¸è€…åœ¨ </span><code>PreCommit</code><span> é˜¶æ®µçš„ YES å“åº”ï¼Œé‚£ä¹ˆåè°ƒè€…å°†ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ </span><code>DoCommit</code><span> è¯·æ±‚ï¼Œ</span><strong><span>å‚ä¸è€…æ”¶åˆ° </span><code>DoCommit</code><span> è¯·æ±‚ååˆ™ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤å·¥ä½œ</span></strong><span>ï¼Œå®Œæˆååˆ™ä¼šç»™åè°ƒè€…è¿”å›å“åº”ï¼Œåè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…è¿”å›çš„äº‹åŠ¡æäº¤æˆåŠŸçš„å“åº”ä¹‹ååˆ™å®Œæˆäº‹åŠ¡ã€‚è‹¥åè°ƒè€…åœ¨ </span><code>PreCommit</code><span> é˜¶æ®µ </span><strong><span>æ”¶åˆ°äº†ä»»ä½•ä¸€ä¸ª NO æˆ–è€…åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„å“åº”</span></strong><span> ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œä¸­æ–­è¯·æ±‚çš„å‘é€ï¼Œå‚ä¸è€…æ”¶åˆ°ä¸­æ–­è¯·æ±‚ååˆ™ä¼š </span><strong><span>é€šè¿‡ä¸Šé¢è®°å½•çš„å›æ»šæ—¥å¿—</span></strong><span> æ¥è¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œï¼Œå¹¶å‘åè°ƒè€…åé¦ˆå›æ»šçŠ¶å†µï¼Œåè°ƒè€…æ”¶åˆ°å‚ä¸è€…è¿”å›çš„æ¶ˆæ¯åï¼Œä¸­æ–­äº‹åŠ¡ã€‚</span></p></li></ul></li><li><p><code>3PC</code><span> åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œäº†è¶…æ—¶ä¸­æ–­çš„å¤„ç†ï¼Œæ¯”å¦‚åè°ƒè€…åœ¨æŒ‡å®šæ—¶é—´å†…æœªæ”¶åˆ°å…¨éƒ¨çš„ç¡®è®¤æ¶ˆæ¯åˆ™è¿›è¡Œäº‹åŠ¡ä¸­æ–­çš„å¤„ç†ï¼Œè¿™æ ·èƒ½ </span><strong><span>å‡å°‘åŒæ­¥é˜»å¡çš„æ—¶é—´</span></strong><span> ã€‚</span></p></li><li><p><strong><code>3PC</code><span> åœ¨ </span><code>DoCommit</code><span> é˜¶æ®µå‚ä¸è€…å¦‚æœªæ”¶åˆ°åè°ƒè€…å‘é€çš„æäº¤äº‹åŠ¡çš„è¯·æ±‚ï¼Œå®ƒä¼šåœ¨ä¸€å®šæ—¶é—´å†…è¿›è¡Œäº‹åŠ¡çš„æäº¤</span></strong><span>ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿæ˜¯å› ä¸ºè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è‚¯å®š</span><strong><span>ä¿è¯äº†åœ¨ç¬¬ä¸€é˜¶æ®µæ‰€æœ‰çš„åè°ƒè€…å…¨éƒ¨è¿”å›äº†å¯ä»¥æ‰§è¡Œäº‹åŠ¡çš„å“åº”</span></strong><span>ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æœ‰ç†ç”±</span><strong><span>ç›¸ä¿¡å…¶ä»–ç³»ç»Ÿéƒ½èƒ½è¿›è¡Œäº‹åŠ¡çš„æ‰§è¡Œå’Œæäº¤</span></strong><span>ï¼Œæ‰€ä»¥</span><strong><span>ä¸ç®¡</span></strong><span>åè°ƒè€…æœ‰æ²¡æœ‰å‘æ¶ˆæ¯ç»™å‚ä¸è€…ï¼Œè¿›å…¥ç¬¬ä¸‰é˜¶æ®µå‚ä¸è€…éƒ½ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤æ“ä½œã€‚</span></p></li><li><p><span>ä¸2PCåŒºåˆ«ï¼šç¬¬äºŒé˜¶æ®µæ‰å†™undoå’Œredoäº‹åŠ¡æ—¥å¿— ç¬¬ä¸‰é˜¶æ®µåè°ƒè€…å‡ºç°å¼‚å¸¸æˆ–ç½‘ç»œè¶…æ—¶å‚ä¸è€…ä¹Ÿä¼šcommit</span></p></li><li><p><span>ä¼˜ç‚¹ï¼šæ”¹å–„åŒæ­¥é˜»å¡ æ”¹å–„å•ç‚¹æ•…éšœ</span></p></li><li><p><span>ç¼ºç‚¹ï¼šåŒæ­¥é˜»å¡ å•ç‚¹æ•…éšœ æ•°æ®ä¸ä¸€è‡´ å®¹é”™æœºåˆ¶ä¸å®Œå–„</span></p></li></ul></li></ul><h3 id='zookeeper-æ¶æ„'><span>Zookeeper æ¶æ„</span></h3><p>&nbsp;</p><p>&nbsp;</p><h1 id='äº”rpc'><span>äº”ã€RPC</span></h1><h2 id='1-ä¸€ä¸ªrpcè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹'><span>1. ä¸€ä¸ªRPCè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹</span></h2><h3 id='11-æ¦‚è¿°'><span>1.1. æ¦‚è¿°</span></h3><p><img src="assets/1714529856788-705b8ad5-9243-490d-a86f-e73928273bca.png" referrerpolicy="no-referrer" alt="img"></p><p><span>åˆ†ä¸ºclientç«¯å’Œserverç«¯</span></p><h3 id='12-clientç«¯'><span>1.2. Clientç«¯</span></h3><p><span>clientç«¯åŒ…æ‹¬ï¼šå®¢æˆ·ç«¯ä»£ç†ï¼Œå®¢æˆ·ç«¯Filterï¼Œè¿æ¥æ± ï¼Œä¸šåŠ¡çº¿ç¨‹æ± ï¼ŒNettryClient</span></p><h4 id='121-å®¢æˆ·ç«¯ä»£ç†'><span>1.2.1. å®¢æˆ·ç«¯ä»£ç†</span></h4><p><span>RPCè¦æ±‚åƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·è°ƒç”¨è¿œç¨‹å‡½æ•°ï¼Œæ‰€ä»¥éœ€è¦å¯¹è°ƒç”¨æ–¹å±è”½ç»†èŠ‚ã€‚ä½¿ç”¨ä»£ç†æ¨¡å¼æ¥å®ç°ã€‚</span></p><h4 id='122-å®¢æˆ·ç«¯filter'><span>1.2.2. å®¢æˆ·ç«¯Filter</span></h4><p><span>ä»£ç†æ¨¡å¼çš„å…·ä½“å®ç°ï¼Œæ˜¯ç”¨è´£ä»»é“¾æ¨¡å¼è¡”æ¥ï¼Œä¸ºæ¡†æ¶æä¾›äº†é«˜å¯æ‰©å±•æ€§ã€‚ç›®å‰FilteråŒ…å«ï¼šæœåŠ¡ç›‘æ§ï¼ŒæœåŠ¡è·¯ç”±ï¼Œæ•…éšœæ³¨å…¥ï¼ŒæœåŠ¡é‰´æƒï¼ŒæœåŠ¡é™çº§ï¼ŒæœåŠ¡è°ƒç”¨ç­‰æ¨¡å—ã€‚</span></p><h4 id='123-è¿æ¥æ± '><span>1.2.3. è¿æ¥æ± </span></h4><p><span>è¿æ¥æ± çš„æ¦‚å¿µæ˜¯è°ƒç”¨ç«¯åšIOæ“ä½œæ—¶éœ€è¦åˆ›å»ºçš„å¯¹è±¡ï¼Œçº¿ç¨‹æ± æ˜¯æœåŠ¡å•å¤„ç†ä¸šåŠ¡é€»è¾‘æ—¶éœ€è¦åˆ›å»ºçš„å¯¹è±¡ã€‚Pigeonå…è®¸å®¢æˆ·ç«¯ä¸ä¸€ä¸ªæœåŠ¡ç«¯æœºå™¨å»ºç«‹å¤šä¸ªè¿æ¥</span></p><h4 id='124-çº¿ç¨‹æ± '><span>1.2.4. çº¿ç¨‹æ± </span></h4><p><span>è´Ÿè´£åœ¨æ”¶åˆ°æœåŠ¡ç«¯è¿”å›çš„æ•°æ®åï¼Œé€šçŸ¥ï¼ˆå”¤é†’ï¼‰ä¸šåŠ¡çº¿ç¨‹</span></p><h4 id='125-netty-client'><span>1.2.5. Netty Client</span></h4><p><span>Pigeonå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„é€šä¿¡æ˜¯äº¤ç»™Nettyå®Œæˆçš„ï¼Œè€ŒNettyæ˜¯åŸºäºReactoræ¨¡å‹å®ç°çš„åŸºäºæ—¶é—´é©±åŠ¨çš„ç½‘ç»œI/Oæ¡†æ¶ï¼Œå…¶åŒ…å«Bossï¼ˆReactoræ¨¡å‹ä¸­çš„MainReactorï¼‰ï¼ŒWorker(Reactoræ¨¡å‹ä¸­çš„SubReactor)ä»¥åŠåŸºäºChannelçš„Pipelineã€‚</span></p><h5 id='1251-boss'><span>1.2.5.1. Boss</span></h5><p><span>åœ¨å®¢æˆ·ç«¯ä¸­ï¼Œè´Ÿè´£å‘èµ·connectè¯·æ±‚ï¼Œè€Œåœ¨æœåŠ¡ç«¯ä¸­åˆ™è´Ÿè´£acceptå®¢æˆ·ç«¯å‘æ¥çš„connectè¯·æ±‚ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥åï¼Œåˆ™å°†ç›¸åº”çš„è¿æ¥ä¸¢ç»™Workerå»ç»´æŠ¤ã€‚</span></p><h5 id='1252-worker'><span>1.2.5.2. Worker</span></h5><p><span>è´Ÿè´£è½®è¯¢è¿æ¥ï¼ˆI/Oå¤šè·¯å¤ç”¨ï¼‰æ˜¯å¦æœ‰æ•°æ®é€è¾¾ï¼Œå¹¶è´Ÿè´£å°†æ•°æ®è¯»å†™åˆ°æƒ³å“åº”çš„channelä¸­</span></p><h5 id='1253-pipeline'><span>1.2.5.3. Pipeline</span></h5><p><span>è´Ÿè´£å¯¹Channelä¸­çš„æ•°æ®è¿›è¡ŒåŠ å·¥ï¼Œåœ¨Pigeonä¸­ï¼Œå…¶ä¸»è¦åŒ…å«ï¼šåºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ï¼Œå®Œæ•´æ€§æ ¡éªŒï¼Œè§£å‹ç¼©ã€‚</span></p><h3 id='13-serverç«¯'><span>1.3. Serverç«¯</span></h3><p><span>Serverç«¯åŒ…æ‹¬ï¼šæœåŠ¡æ®µFilterï¼Œä¸šåŠ¡çº¿ç¨‹æ± ï¼ŒNetteyServerã€‚</span></p><h4 id='131-æœåŠ¡ç«¯filter'><span>1.3.1. æœåŠ¡ç«¯Filter</span></h4><p><span>ä¸å®¢æˆ·ç«¯Filterå¯¹åº”ï¼Œä¸€ä¸ªè¯·æ±‚åœ¨è¿›å…¥ä¸šåŠ¡ä»£ç ä¹‹é—´ï¼Œè¦ç»è¿‡ï¼šæœåŠ¡ç›‘æ§ï¼ŒæœåŠ¡é‰´æƒï¼ŒæœåŠ¡é™æµç­‰æ¨¡å—</span></p><h4 id='132-çº¿ç¨‹æ± '><span>1.3.2. çº¿ç¨‹æ± </span></h4><p><span>å°†ä¸šåŠ¡é€»è¾‘ä»I/Oæ“ä½œä¸­å‰¥ç¦»ï¼Œæ•°æ®å‡†å¤‡å¥½åï¼Œï¼Œä¸šåŠ¡ä»£ç å°†åœ¨ä¸šåŠ¡çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œåœ¨Pigeonä¸­ï¼Œä¸ºäº†é˜²æ­¢æ…¢è¯·æ±‚å½±å“å…¶ä»–çš„æ­£å¸¸æƒ…å†µï¼Œä¼šå°†æ»¡è¶³ä¸€å®šæ¡ä»¶çš„æ…¢è¯·æ±‚éš”ç¦»åˆ°SlowRquestPoolingä¸­ã€‚</span></p><h4 id='133-netty-server'><span>1.3.3. Netty Server</span></h4><p><span>ä¸nettyClientç±»ä¼¼ã€‚</span></p><h3 id='14-æ‰§è¡Œè¿‡ç¨‹'><span>1.4. æ‰§è¡Œè¿‡ç¨‹</span></h3><p><img src="assets/1714533513826-901b80fb-f1ff-4d78-a738-cbd7001f857a.png" referrerpolicy="no-referrer" alt="img"></p><p><span>å‡è®¾å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥ä¹‹åï¼Œå®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æœåŠ¡</span></p><ol start='' ><li><p><span>é¦–å…ˆåœ¨å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æœåŠ¡å‘æ”¾æ—¶ï¼ŒçœŸæ­£è°ƒç”¨çš„æ˜¯InvocationHandlerä¸­çš„invokeæ–¹æ³•ï¼ˆè¿™é‡Œä½¿ç”¨JDKçš„åŠ¨æ€ä»£ç†ï¼‰ã€‚pigeonä¸­InvocationHandlerçš„å®ç°ä¸ºServiceInvocationProxy, ä»»æ„æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè¿›å…¥åˆ°ServiceInvocationProxy.invokeæ–¹æ³•</span></p></li><li><p><span>ServiceInvocationProxy.invokeä¸­ä¼šè°ƒç”¨å®¢æˆ·ç«¯Filterï¼Œè¯·æ±‚ä¼šä¾æ¬¡ç»è¿‡ç›‘æ§ï¼Œè·¯ç”±ï¼Œé™çº§ï¼Œç½‘å…³ï¼Œé‰´æƒç­‰æ¨¡å—åï¼Œè¿›å…¥RemoteCallInvokeFIlterã€‚</span></p></li><li><p><span>åœ¨RemoteCallInvokeFIlterä¸­è°ƒç”¨Client.writeæ–¹æ³•ï¼Œå…¶é€»è¾‘ä»è¿æ¥æ± ä¸­è·å–è¿æ¥ï¼ˆæœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼‰ï¼Œç„¶åå°†æ•°æ®å†™å…¥Channelã€‚</span></p></li><li><p><span>åœ¨æœåŠ¡ç«¯å‘é€æ•°æ®ä¹‹å‰ï¼Œéœ€è¦ç»è¿‡Channelçš„Pipelineï¼ˆåºåˆ—åŒ–ï¼Œå‹ç¼©ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡)ã€‚</span></p></li><li><p><span>ç„¶åå°±å¼€å§‹å‘æœåŠ¡ç«¯å‘é€æ•°æ®ï¼Œç”±äºNettyå‘é€æ¶ˆæ¯æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å¦‚æœæ˜¯åŒæ­¥è°ƒç”¨çš„è¯ï¼ŒPigeonè¿™é‡Œä¼šè®©ä¸šåŠ¡çº¿ç¨‹ä¸»åŠ¨awaitï¼Œç›´åˆ°æ”¶åˆ°æœåŠ¡ç«¯ç›¸åº”æˆ–è€…è¶…æ—¶åå”¤é†’ã€‚</span></p></li><li><p><span>æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯åï¼Œä»channelä¸­å°†æ¶ˆæ¯è¯»å‡ºæ¥ï¼Œä¹Ÿä¼šå…ˆç»è¿‡ä¸€äº›Pipeline(ååºåˆ—åŒ–ï¼Œè§£å‹ç¼©ç­‰)ååˆ°è¾¾NettyServerHandler,åœ¨å…¶ä¸­Pigeonè¿™é‡Œè¿˜åšäº†æœåŠ¡éš”ç¦»çš„è®¾è®¡</span></p></li><li><p><span>é»˜è®¤çš„éš”ç¦»æœºåˆ¶ï¼ˆç»Ÿè®¡å’Œéš”ç¦»çº§åˆ«éƒ½æ˜¯æ–¹æ³•çº§çš„ï¼‰ï¼šå½“è¶…æ—¶æ•°è¶…è¿‡300æˆ–è€…è¶…æ—¶ç‡è¶…è¿‡5%ï¼Œå°±å°†åç»­å¯¹åº”çš„è¯·æ±‚æ”¾å…¥slowçº¿ç¨‹æ± å¤„ç†ã€‚å½“è¶…æ—¶æ•°ä½äº300ï¼Œæˆ–è€…è¶…æ—¶ç‡ä½äº5%ï¼Œå°±å°†åç»­å¯¹åº”çš„è¯·æ±‚æ”¾å…¥shardçº¿ç¨‹æ± å¤„ç†ã€‚</span></p></li><li><p><span>é»˜è®¤è¿˜å¼€å¯æ–¹æ³•é™æµï¼Œé™åˆ¶å•ä¸ªæ–¹æ³•ä¸èƒ½å ç”¨Xä¸ªçº¿ç¨‹</span></p></li><li><p><span>æä¾›ä¸šåŠ¡è‡ªå®šä¹‰ç‹¬ç«‹çº¿ç¨‹æ± çš„æ”¯æŒ</span></p></li><li><p><span>åœ¨é€‰æ‹©ç›¸åº”çš„çº¿ç¨‹æ± å¹¶æˆåŠŸæ‹¿åˆ°çº¿ç¨‹ä¹‹åï¼Œè¯·æ±‚å°±åˆ°äº†æœåŠ¡ç«¯Filterä¸­ï¼Œè¯·æ±‚ä¼šä¾æ¬¡ç»è¿‡ç›‘æ§ï¼Œæµé‡å½•åˆ¶ï¼Œé‰´æƒï¼Œæ³›åŒ–è°ƒç”¨ï¼Œç½‘å…³ç­‰æ¨¡å—ï¼Œè¿›å…¥BusinessProcessFilter.</span></p></li><li><p><span>åœ¨BusinessProcessFilterä¸­ä¼šæ ¹æ®å®¢æˆ·ç«¯ä¼ é€’å¼€çš„æœåŠ¡ä¿¡æ¯å’Œå‚æ•°ï¼Œé€šè¿‡åå°„è°ƒç”¨ç›¸åº”çš„ä¸šåŠ¡æœåŠ¡å¹¶æ‹¿åˆ°ä¸šåŠ¡å¤„ç†ç»“æœï¼Œç„¶åå†WriteRespinseProcessFilterä¸­å°†è¿”å›ç»“æœå†™å…¥channel</span></p></li><li><p><span>è¿”å›ç»“æœå†ç»è¿‡æœåŠ¡ç«¯çš„Pipelineå¤„ç†ï¼ˆåºåˆ—åŒ–ï¼Œå‹ç¼©ç­‰ï¼‰ï¼Œå°±å‘ç»™å®¢æˆ·ç«¯</span></p></li><li><p><span>å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯åï¼Œç»è¿‡å®¢æˆ·ç«¯çš„Pipelineå¤„ç†ï¼ˆååºåˆ—åŒ–ï¼Œè§£å‹ç¼©ç­‰ï¼‰ååˆ°è¾¾NettyClientHandleï¼Œç„¶åäº¤ç»™ResponseThreadPoolProcessorçº¿ç¨‹æ± å¤„ç†ã€‚</span></p></li><li><p><span>ResponseThreadPoolProcessoræ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šé€šçŸ¥ä¹‹å‰awaitçš„ä¸šåŠ¡çº¿ç¨‹ï¼Œå¹¶å°†ç»“æœä¼ é€’ç»™ä»–</span></p></li><li><p><span>ä¸šåŠ¡çº¿ç¨‹æ”¶åˆ°signalé€šçŸ¥åï¼Œå°±å°†ç»“æœè¿”å›ç»™ä¹‹å‰çš„æ–¹æ³•è°ƒç”¨ã€‚</span></p></li></ol><h1 id='å…­é“¾è·¯è¿½è¸ª'><span>å…­ã€é“¾è·¯è¿½è¸ª</span></h1><h1 id='ä¸ƒåˆ†å¸ƒå¼äº‹åŠ¡'><span>ä¸ƒã€åˆ†å¸ƒå¼äº‹åŠ¡</span></h1></div></div>

<script>(function(){var e=document.body.parentElement,t=[],n=null,i=document.body.classList.contains("typora-export-collapse-outline"),r=function(e,t,n){document.addEventListener(e,function(e){if(!e.defaultPrevented)for(var i=e.target;i&&i!=this;i=i.parentNode)if(i.matches(t)){!1===n.call(i,e)&&(e.preventDefault(),e.stopPropagation());break}},!1)};function o(){return e.scrollTop}r("click",".outline-expander",function(e){var t=this.closest(".outline-item-wrapper").classList;return t.contains("outline-item-open")?t.remove("outline-item-open"):t.add("outline-item-open"),d(),!1}),r("click",".outline-item",function(e){var t=this.querySelector(".outline-label");if(location.hash="#"+t.getAttribute("href"),i){var n=this.closest(".outline-item-wrapper").classList;n.contains("outline-item-open")||n.add("outline-item-open"),c(),n.add("outline-item-active")}});var a,s,l=function(){var e=o();n=null;for(var i=0;i<t.length&&t[i][1]-e<60;i++)n=t[i]},c=function(){document.querySelectorAll(".outline-item-active").forEach(e=>e.classList.remove("outline-item-active")),document.querySelectorAll(".outline-item-single.outline-item-open").forEach(e=>e.classList.remove("outline-item-open"))},d=function(){if(n){c();var e=document.querySelector('.outline-label[href="#'+(CSS.escape?CSS.escape(n[0]):n[0])+'"]');if(e)if(i){var t=e.closest(".outline-item-open>ul>.outline-item-wrapper");if(t)t.classList.add("outline-item-active");else{for(var r=(e=e.closest(".outline-item-wrapper")).parentElement.closest(".outline-item-wrapper");r;)r=(e=r).parentElement.closest(".outline-item-wrapper");e.classList.add("outline-item-active")}}else e.closest(".outline-item-wrapper").classList.add("outline-item-active")}};window.addEventListener("scroll",function(e){a&&clearTimeout(a),a=setTimeout(function(){l(),d()},300)});var u=function(){s=setTimeout(function(){!function(){t=[];var e=o();document.querySelector("#write").querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(n=>{var i=n.getAttribute("id");t.push([i,e+n.getBoundingClientRect().y])})}(),l(),d()},300)};window.addEventListener("resize",function(e){s&&clearTimeout(s),u()}),u()})();</script></body>
</html>