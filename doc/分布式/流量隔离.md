## 背景

业界体量较大的公司，随着业务高速发展，很快就面临容灾能力不足，扩展瓶颈等问题同时出现。比如：单机房部署、单地区部署风险越来越高，一旦出问题，会引发难以承受的商业风险；以及IDC容量不足，增加IDC需在业务层面中调整路由规则；数据库连接池使用达到极限无法再增加等问题。 在高速发展的业务场景下，上述问题会同时出现，需要一个系统的解决方案。比如在阿里和蚂蚁金服，花费3年左右，整体具备异地多活能力，蚂蚁金服还实现了三地五中心的金融级容灾部署架构。SET化解决方案的出现，极大地解决了上述问题，大禹作为SET化专用的管理运营平台也相应诞生。之后，为了帮助业务解决更加通用化的流量隔离的问题，提供了的流量隔离解决方案LiteSET，由大禹承担核心的策略管理和服务编排功能。近些年，美团有大量新业务需要探索，需具备快速响应新业务迭代诉求的能力，为新业务建立覆盖全链路的独立支撑环境，基于此，大禹规划建设了标准业务隔离解决方案。

## 解决了什么问题

主要解决流量调度和流量隔离业务场景下的相关问题，通过如下方式来支撑这些问题的解决：

1. 承担SET、LiteSET、业务分组、泳道中的核心路由能力实现，支撑对应方案的落地。
2. 组合编排各组件（Orchestration & Provisioning）能力，提高流量调度和流量隔离场景下的运维效率，降低使用成本。例如自动建站-服务编排功能。
3. 提供具体解决方案，解决特定业务场景问题。例如业务隔离解决方案、SET克隆解决方案。

## 如何实现？

- 如何实现策略管理的？

各种策略的管理分为两类：1）只作为入口，策略管理不在大禹，这种直接托管给对应的组件，比如HTTP分流策略直接由Oceanus管理。2）大禹直接管理的策略，如RPC分流策略（包括RPC公共策略）、业务分组染色&路由策略等，业务在大禹管控平台对策略进行增删改查后，首先经过MCM/CF审核，审核后将策略存储在RDS，根据不同的策略类型，将策略组装成特定的格式，调用Lion，将其下发到对应的Appkey空间（业务服务Appkey空间或者大禹公共空间），由Lion负责将配置最终下发到对应的Appkey服务实例，后续即可供大禹SDK使用。

- DAYU是如何实现流量路由的？

大禹流量路由在数据面实现，业务服务在调用组件（如MTthrift、Pigeon、Zebra、Cellar、Squirrel、Mafka等）操作时，各组件会首先调用大禹SDK获取路由分组，大禹SDK根据1）上下文信息（如appenv中的环境信息、MTrace中的流量信息等）；2）策略信息（通过Lion获取配置，并解析成大禹SDK使用的格式）；3）自定义路由信息（如直接指定某一SET）；4）默认路由规则（如同SET路由、默认fallback规则），进行计算，最终计算出路由分组（即SET/LiteSET值、业务分组值、泳道值），各组件根据结果，查找具体的资源，并进行调用，最终完成整个流量路由。

- 如何实现自动建站的？

自动建站的编排阶段，大禹会将编排信息（如Appkey、部署机房、机器数量、机器配置、镜像等）存储在大禹RDS。发布阶段，大禹后台对服务编排中的每个Appkey异步发起部署，对于每个待发布的Appkey从Plus查询稳定镜像地址，然后调用Avatar使用指定镜像对指定SET/LiteSET进行扩容机器，最终完成整个发布过程。

- 如何保证产品的可靠性？

大禹SDK强依赖MTrace、弱依赖Lion。Lion客户端不可用时，仍可以工作，但不能及时更新策略，恢复后，可获取最新策略。

大禹WEB前端和WEB服务采用北上两地四机房部署，支持Region级容灾；

依赖的RDS采用主从集群部署，主从节点部署北京两机房，支持AZ级容灾；

对于不同的产品功能，根据其依赖组件的高可用性，具备不同的容灾和降级措施：

- HTTP分流功能依赖Oceanus的容灾等级和高可用；当大禹不可用但Oceanus可用时，用户可直接降级到Oceanus配置。
- RPC分流功能依赖Lion和MCM的容灾等级；当MCM不可用时，可关闭审核功能，不影响核心链路；当大禹不可用但Lion可用时，可降级到Lion手动修改配置，但体验较差。
- 自动建站功能依赖Plus、Avatar的容灾等级；当大禹不可用但Avatar可用时，用户可降级到Avatar按Appkey逐个手动扩缩机器，也可到Hulk弹性伸缩进行扩缩容。
- 其他功能依靠对外依赖组件的容灾等级，暂无降级方案。