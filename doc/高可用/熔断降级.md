# 1. 背景

![img](https://cdn.nlark.com/yuque/0/2024/png/42819892/1715777536387-00cece86-5fbc-489d-a023-e9b9b2dfab72.png)

如果请求调用链路上有一个服务出现故障，如上图的服务A出现故障，错误会随着调用链路一级一级向上传播，进而导致API出现故障，进一步导致WEB也出现故障，可能由于一个服务出问题导致业务整体不可用。

造成下游服务故障的原因有很多，比如：

- 定时任务导致负载升高
- 代码逻辑问题
- 网络问题

如果没有正确处理的话，服务每次都会调用下游接口，如果是下游服务不可用，每次都会长时间的超时，导致延迟大大增加。

# 2. 熔断降级&重试机制

熔断降级是微服务架构中一种常用的容错机制，它能够保证在分布式系统中，当某个服务出现问题时，不会导致整个系统的瘫痪，提高了系统的可用性和稳定性。

熔断（Circuit Breaker）是一种自动化的保护机制，当某个服务出现错误或延迟等异常情况时，熔断器会自动切断对该服务的调用。熔断器有三种状态：关闭状态（Closed）、打开状态（Open）和半开状态（Half-Open）。在正常情况下，熔断器处于关闭状态，当请求次数、失败率、失败数同时达到设定阈值时，熔断器会切换到打开状态，此时对该服务的调用会全部被降级。在经过一段时间的休眠后，熔断器进入半开状态，允许部分请求访问服务，如果服务恢复正常，则熔断器返回关闭状态；如果仍然存在问题，熔断器会再次切换到打开状态。

降级（Degradation）是在服务出现异常时采取的一种应对措施，通过降低服务的功能或质量，以减轻系统压力。降级策略通常包括：返回默认值、返回缓存数据、返回简化数据或直接忽略非关键服务等。降级的目标是在保证核心功能正常运行的情况下，牺牲部分次要功能或服务质量，避免整个系统因为单一服务异常而崩溃。

熔断降级的基本作用如下：

保护资源：当某个服务出现异常时，熔断器可以切断对该服务的调用，防止过多的请求涌入，避免资源耗尽。

提高可用性：通过熔断降级机制，系统可以在出现异常时自动进行容错处理，保证系统整体的可用性。

隔离故障：熔断降级可以将故障隔离在单个服务上，防止故障扩散，提高系统的稳定性。

快速故障响应：当服务出现异常时，熔断降级可以迅速响应，避免用户长时间等待。

提高系统容错能力：在分布式系统中，熔断降级能够帮助系统应对各种异常情况，提高系统的容错能力。

 

对于这种问题，比较好的方式在依赖的服务不可用时，服务调用方通过一些技术手段，向上提供有损服务，保证业务柔性可用。

![img](https://cdn.nlark.com/yuque/0/2024/png/42819892/1715777689332-8824fe72-6faf-466d-9b57-f69a163cd588.png)

| 名称   | 解释                             |
| ------ | -------------------------------- |
| 强依赖 | 用户有感知，出错会影响整体流量   |
| 弱依赖 | 用户无感知，出错不会影响整体流程 |

**重试机制**，如果下游的的接口是核心依赖（强依赖），在出现异常的情况下，可以通过重试尽可能的保证成功率，下游服务如果没有出现大面积的异常，通过重试就可以获取到正常的响应。

常见的重试策略有两种：

1. **固定间隔时间重试**：每次重试之间都使用相同的时间间隔，比如每隔 1.5 秒进行一次重试。这种重试策略的优点是实现起来比较简单，不需要考虑重试次数和时间的关系，也不需要维护额外的状态信息。但是这种重试策略的缺点是可能会导致重试过于频繁或过于稀疏，从而影响系统的性能和效率。如果重试间隔太短，可能会对目标系统造成过大的压力，导致雪崩效应；如果重试间隔太长，可能会导致用户等待时间过长，影响用户体验。
2. **梯度间隔重试**：根据重试次数的增加去延长下次重试时间，比如第一次重试间隔为 1 秒，第二次为 2 秒，第三次为 4 秒，以此类推。这种重试策略的优点是能够有效提高重试成功的几率（随着重试次数增加，但是重试依然不成功，说明目标系统恢复时间比较长，因此可以根据重试次数延长下次重试时间），也能通过柔性化的重试避免对下游系统造成更大压力。但是这种重试策略的缺点是实现起来比较复杂，需要考虑重试次数和时间的关系，以及设置合理的上限和下限值。另外，这种重试策略也可能会导致用户等待时间过长，影响用户体验。

这两种适合的场景各不相同。固定间隔时间重试适用于目标系统恢复时间比较稳定和可预测的场景，比如网络波动或服务重启。梯度间隔重试适用于目标系统恢复时间比较长或不可预测的场景，比如网络故障和服务故障。

**重试的次数**不宜过多，否则依然会对系统负载造成比较大的压力。

重试的次数通常建议设为 3 次。大部分情况下，我们还是更建议使用梯度间隔重试策略，比如说我们要重试 3 次的话，第 1 次请求失败后，等待 1 秒再进行重试，第 2 次请求失败后，等待 2 秒再进行重试，第 3 次请求失败后，等待 3 秒再进行重试。

**熔断降级功能**，如果下游的接口是弱依赖，可以监控接口每次调用的健康度，如果健康度低于设置的阈值时，自动熔断所依赖的下游服务，直接返回降级数据，保证服务可用。

![img](https://cdn.nlark.com/yuque/0/2024/png/42819892/1715778065469-830bf37b-2a59-4880-aa3d-6a5e4c7878e3.png)